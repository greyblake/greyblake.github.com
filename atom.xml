<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Sergey Potapov]]></title>
  <link href="http://greyblake.com/atom.xml" rel="self"/>
  <link href="http://greyblake.com/"/>
  <updated>2015-09-21T00:21:31+02:00</updated>
  <id>http://greyblake.com/</id>
  <author>
    <name><![CDATA[Sergey Potapov]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[NLP, Toki Pona and Ruby: part 1]]></title>
    <link href="http://greyblake.com/blog/2015/09/20/nlp-toki-pona-and-ruby-part1/"/>
    <updated>2015-09-20T20:36:00+02:00</updated>
    <id>http://greyblake.com/blog/2015/09/20/nlp-toki-pona-and-ruby-part1</id>
    <content type="html"><![CDATA[<h2>Intro</h2>

<p>During last few years, I spent a lot of time learning foreign languages like Esperanto, Spanish and German.
After a while, I came up with an idea that I can apply this knowledge in computer science.</p>

<p>When I decided this I was completely new to Computational Linguistics(CL) and Natural Language Processing(NLP).
However after reading a number of articles I got some basic ideas.</p>

<h2>What I am gonna do</h2>

<p>To dive into CL/NLP I&#8217;ve decided implement Toki Pona -> English translator from scratch.
It&#8217;s interesting to see which issues I will face and how I will solve them.
It will make me go through number of stages of language processing:</p>

<ul>
<li>Lexical analysis</li>
<li>Language detection (I want to distinguish Toki Pona from other languages)</li>
<li>Morphological analysis (actually will be skipped because of simplicity of Toki Pona)</li>
<li>Syntax analysis</li>
<li>Word translation</li>
<li>Syntax tree conversion</li>
<li>Generation of final translation with respect to English grammar.</li>
</ul>


<p>Anyway, this list is not strict, and probably it will be modified in the future.</p>

<h2>What I am not gonna do</h2>

<p>There are many tools and libraries that already exist in Ruby for NLP.
I am not gonna use any of them here neither cover them in the articles.
If you need something like that, please take a look at <a href="https://github.com/diasks2/ruby-nlp">ruby-nlp</a>.
It&#8217;s a document that gathers a variety of NLP tools implemented in ruby.</p>

<h2>What is Toki Pona?</h2>

<p><a href="https://en.wikipedia.org/wiki/Toki_Pona">Toki Pona</a> is a constructed language created by Sonja Lang in 2001.
What is so special about it? Its vocabulary is limited and contains only <strong>125 words</strong>.
The grammar is regular (anyway there will be some pitfalls). The language itself simple and can be learned in 1-2 nights,
and I believe it allows to express 80-90% of daily human communication. Also, it has some philosophical background:
speaking the language you realize what things really are.</p>

<p>Example: there is no word like &#8220;friend&#8221;, one would say &#8220;jan pona&#8221;, what literally  means &#8220;good person/human&#8221;.
In similar way &#8220;an ocean&#8221; is &#8220;telo suli&#8221; (big water), &#8220;juice&#8221; is &#8220;telo kili&#8221; (water of fruit or vegetable), etc.</p>

<p>So, even Toki Pona is not real <em>natural</em> language, it&#8217;s good to experiment with, and it gives me some hope that my
goal can be achieved :)</p>

<p>And the end of this article you&#8217;ll find number of useful links if you want to get into the language.</p>

<h2>First step: lexical analysis</h2>

<p>The first step in processing natural or programming language is <strong>lexical analysis</strong>. It means splitting sequence of
characters into some meaningful units: <strong>tokens</strong>. Sometimes the process is called <strong>tokenization</strong> and
the tools that do it are <strong>tokenizers</strong> or <strong>lexical analyzers</strong>.</p>

<p>Let&#8217;s see an example. Given a sentence:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>jan suli li pona.</span></code></pre></td></tr></table></div></figure>


<p>Translation: &#8220;Big man is good&#8221;
(<em>jan</em> - human/man, <em>suli</em> - big, <em>li</em> - is/are, <em>pona</em> - good).</p>

<p>Note: in Toki Pona the main word goes first, so noun(<em>jan</em>) is on the first position,
and on the second position is adjective(<em>suli</em>) that modifies the noun.</p>

<p>Expected list of tokens is</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="s2">&quot;jan&quot;</span><span class="p">,</span> <span class="s2">&quot;suli&quot;</span><span class="p">,</span> <span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="s2">&quot;pona&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s implement class <code>Tokipona::Tokenizer</code> with a class method <code>.tokenize</code> that returns an array of
tokens for a given text. We start with tests first.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="ss">Tokipona</span><span class="p">:</span><span class="ss">:Tokenizer</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;.tokenize&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">context</span> <span class="s2">&quot;only words&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;returns array of words&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;toki mi li toki pona&quot;</span>
</span><span class='line'>        <span class="n">tokens</span> <span class="o">=</span> <span class="n">described_class</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;toki&quot;</span><span class="p">,</span> <span class="s2">&quot;mi&quot;</span><span class="p">,</span> <span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="s2">&quot;toki&quot;</span><span class="p">,</span> <span class="s2">&quot;pona&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">context</span> <span class="s2">&quot;words with multiple spaces in between&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;returns array of words&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;toki   mi   li   toki   pona&quot;</span>
</span><span class='line'>        <span class="n">tokens</span> <span class="o">=</span> <span class="n">described_class</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;toki&quot;</span><span class="p">,</span> <span class="s2">&quot;mi&quot;</span><span class="p">,</span> <span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="s2">&quot;toki&quot;</span><span class="p">,</span> <span class="s2">&quot;pona&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">context</span> <span class="s2">&quot;words with special characters&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;returns array of words and characters&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;sina wile lape anu seme, jan lane?&quot;</span>
</span><span class='line'>        <span class="n">tokens</span> <span class="o">=</span> <span class="n">described_class</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;sina&quot;</span><span class="p">,</span> <span class="s2">&quot;wile&quot;</span><span class="p">,</span> <span class="s2">&quot;lape&quot;</span><span class="p">,</span> <span class="s2">&quot;anu&quot;</span><span class="p">,</span> <span class="s2">&quot;seme&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;jan&quot;</span><span class="p">,</span> <span class="s2">&quot;lane&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;does not change input text&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;toki mi li pona&quot;</span>
</span><span class='line'>      <span class="n">described_class</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="s2">&quot;toki mi li pona&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Usually lexical analysis for programming languages is based on <a href="http://web.cse.ohio-state.edu/~gurari/course/cse756/html/cse756se2.html">finite-state automata</a>.
But in our simple case we can easily handle it with one regular expression:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Tokipona</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Tokenizer</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@text</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\w+|[^\s]/</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This implementation looks very naive, but specs pass, so we live it as it is.
Probably in the future we will modify.</p>

<h2>Conclusion</h2>

<p>It is the first article and the beginning of the journey. The next step will be an implementation
of Toki Pona language detector. It&#8217;s not necessary to know Toki Pona to follow me,
but in case you are interested, here below I provide some useful links, so you can learn yourself
and start communicating.</p>

<p>I&#8217;ve created a github repository where you can access the code: <a href="https://github.com/greyblake/tokipona">greyblake/tokipona</a>.</p>

<p>P.S.</p>

<p>Thanks for reading. The subject is new for me, so your comments, suggestions and feedback can be very helpful.</p>

<h2>Links</h2>

<ul>
<li><a href="https://en.wikipedia.org/wiki/Toki_Pona">Toki Pona at Wikipedia</a></li>
<li><a href="http://tokipona.org/">Official Toki Pona site</a></li>
<li><a href="http://rowa.giso.de/languages/toki-pona/english/lessons.php">Toki Pona lessons</a> - here you can start learning the language</li>
<li><a href="http://x-raizor.github.io/visual-tokipona/index.html">Toki Pona visual vocabulary</a></li>
<li>#tokipona - IRC channel where you can communicate with other people</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Lazy object pattern in ruby]]></title>
    <link href="http://greyblake.com/blog/2014/10/05/lazy-object-pattern-in-ruby/"/>
    <updated>2014-10-05T21:27:00+02:00</updated>
    <id>http://greyblake.com/blog/2014/10/05/lazy-object-pattern-in-ruby</id>
    <content type="html"><![CDATA[<p>I few days ago my colleague <a href="https://github.com/albertosaurus">Arthur Shagall</a> reviewing my
code suggested me to use <strong>Lazy Object</strong> pattern to postpone some calculations during the load time.
I hadn&#8217;t heard about the pattern before and even googling it didn&#8217;t give my much information.
So I have decided to write this article to cover the topic.</p>

<h2>Intention</h2>

<p><strong>Lazy Object</strong> allows you to postpone some calculation until the moment when the actual
result of the calculation is used. That may help you to speed up booting of the application.</p>

<h2>Implementation</h2>

<p>It is pretty simple. We create a proxy object that takes a calculation
block as its property and execute it on first method call.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">LazyObject</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">BasicObject</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">callable</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@callable</span> <span class="o">=</span> <span class="n">callable</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">__target_object__</span>
</span><span class='line'>    <span class="vi">@__target_object__</span> <span class="o">||=</span> <span class="vi">@callable</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="n">__target_object__</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Usage example 1</h2>

<p>A constant assignment like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SQUARES</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">**</span> <span class="mi">2</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Could be converted to this one:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SQUARES</span> <span class="o">=</span> <span class="no">LazyObject</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">**</span> <span class="mi">2</span><span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So now if you want to use <code>SQUARES</code> it still behaves like an array:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SQUARES</span><span class="o">.</span><span class="n">class</span>  <span class="c1"># =&gt; Array</span>
</span><span class='line'><span class="no">SQUARES</span><span class="o">.</span><span class="n">size</span>   <span class="c1"># =&gt; 10</span>
</span><span class='line'><span class="no">SQUARES</span>        <span class="c1"># =&gt; [0, 1, 4, 9, 16, 25, 36, 49, 64, 81]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Usage example 2</h2>

<p>Let&#8217;s say you have models <code>State</code> and <code>Address</code> in you Rails application.
What you want do is to validate inclusion of <code>address.state</code> in states.</p>

<p>You can just hardcore the list of states:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Address</span> <span class="o">&lt;</span> <span class="o">::</span><span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="no">STATES</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;AL&quot;</span><span class="p">,</span> <span class="s2">&quot;AK&quot;</span><span class="p">,</span> <span class="s2">&quot;AZ&quot;</span><span class="p">,</span> <span class="s2">&quot;AR&quot;</span><span class="p">,</span> <span class="s2">&quot;CA&quot;</span><span class="p">,</span> <span class="s2">&quot;CO&quot;</span><span class="o">]</span>   <span class="c1"># and so on</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:state</span><span class="p">,</span> <span class="ss">inclusion</span><span class="p">:</span> <span class="p">{</span> <span class="k">in</span><span class="p">:</span> <span class="no">STATES</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>But it does not reflect your changes in DB in any way.</p>

<p>Then you can fetch the values from DB:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">STATES</span> <span class="o">=</span> <span class="no">State</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:code</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It seems to look better, but there are 2 possible pitfalls:</p>

<ul>
<li>It increases load time (1 more SQL query)</li>
<li>It may cause real troubles if <code>STATES</code> is initialized before <code>State</code> model is seeded. In this case <code>STATES</code> will be empty.</li>
</ul>


<p>So that is the situation where <strong>Lazy Object</strong> is useful:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">STATES</span> <span class="o">=</span> <span class="no">LazyObject</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="no">State</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:code</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Ruby gem</h2>

<p>If your prefer to have it as a ruby gem,
please take a look at <a href="http://rubygems.org/gems/lazy_object">rubygems.org/gems/lazy_object</a>.</p>

<p>Thanks for reading!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ignore files with git locally]]></title>
    <link href="http://greyblake.com/blog/2014/05/21/ignore-files-with-git-locally/"/>
    <updated>2014-05-21T16:37:00+02:00</updated>
    <id>http://greyblake.com/blog/2014/05/21/ignore-files-with-git-locally</id>
    <content type="html"><![CDATA[<p>Sometimes it&#8217;s necessary to ignore some files in a repository only locally.
For rails developers it&#8217;s often <code>./config/database.yml</code> file.
Every developer has his own database configuration.</p>

<p>With git it can be easily achieved, we may instruct git no to track changes in
certain files:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git update-index --assume-unchanged ./config/database.yml
</span></code></pre></td></tr></table></div></figure>


<p>Next time we type <code>git status</code> the changes in <code>./config/database.yml</code> won&#8217;t be shown.</p>

<p>If you think you need to track that file again, just do:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git update-index --no-assume-unchanged ./config/database.yml
</span></code></pre></td></tr></table></div></figure>


<p>(pay attention to <code>--no</code> prefix).</p>

<p>Thanks!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to compare audio in ruby]]></title>
    <link href="http://greyblake.com/blog/2013/12/19/how-to-compare-audio-in-ruby/"/>
    <updated>2013-12-19T19:51:00+01:00</updated>
    <id>http://greyblake.com/blog/2013/12/19/how-to-compare-audio-in-ruby</id>
    <content type="html"><![CDATA[<h2>Or how to implement sound_like RSpec matcher</h2>

<p>The problem I&#8217;m trying to solve in this article is comparison of two
audio files. We&#8217;ll figure out how to verify that they sound similar.</p>

<p>I was developing an application that has a deal with audio processing and
I had to write a test to verify outcome audio file matches a one
from fixtures. Well, I&#8217;ve decided to compare audio binaries like these:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">expect</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;outcome.mp3&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;fixture.mp3&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And it worked!</p>

<p>But soon my colleagues let me know I had broken the build. It turned out
that <code>outcome.mp3</code>generated on their Mac books didn&#8217;t match <code>fixture.mp3</code>
generated on my linux laptop, despite the fact that both sounded
absolutely the same. Probably we had different codecs.
So I had to come up with a better idea.</p>

<!--more-->


<h2>Audio fingerprints and Chromaprint</h2>

<p>After some investigation I found a term &#8220;audio fingerprint&#8221; or &#8220;acoustic fingerprint&#8221;,
it was exactly what I was looking for. From Wikipedia:</p>

<blockquote><p>An acoustic fingerprint is a condensed digital summary, deterministically generated
from an audio signal, that can be used to identify an audio sample or quickly locate
similar items in an audio database</p></blockquote>

<p>It&#8217;s used by services like Shazam to identify songs.</p>

<p>So I started looking for open source implementations and found
<a href="http://acoustid.org/chromaprint">Chromaprint</a> - a C library that calculates audio fingerprints
from raw audio files. It seemed to be simple, with good source documentation
and easy to get started.</p>

<h2>Integrate Chromaprint with Ruby</h2>

<p>I found no already existing bindings, so I&#8217;ve implemented
<a href="https://github.com/TMXCredit/chromaprint">my own</a>. Instead of using C,
I gave <a href="https://github.com/ffi/ffi">FFI</a> a shot and it worked perfect!
As result I had stuff that worked the following way:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">context</span>     <span class="o">=</span> <span class="ss">Chromaprint</span><span class="p">:</span><span class="ss">:Context</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">44100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="n">fingerprint</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_fingerprint</span><span class="p">(</span><span class="n">raw_audio_data</span><span class="p">)</span>
</span><span class='line'><span class="n">fingerprint</span><span class="o">.</span><span class="n">raw</span> <span class="c1"># =&gt; [294890785, 328373552, 315802880, 303481088, ...]</span>
</span></code></pre></td></tr></table></div></figure>


<p>According to Chromaprint&#8217;s documentation a raw fingerprint is an array of 4 byte integers.
But how to compare to 2 fingerprints to detect similarity?</p>

<h2>Hamming distance</h2>

<p>The answer was to calculate Hamming distance from binary representation of fingerprints.
Again according to Wikipedia:</p>

<blockquote><p>In information theory, the Hamming distance between two strings of equal length is
the number of positions at which the corresponding symbols are different. In another
way, it measures the minimum number of substitutions required to change one string
into the other, or the minimum number of errors that could have transformed one
string into the other.</p></blockquote>

<p>To calculate Hamming distance for binary data we need to apply XOR operation and count
number of 1 in the result.</p>

<p>Here is a small example for 2 byte values:</p>

<pre><code>dec     bin
11737   00101101 11011001
27129   01101001 11111001

XOR     01000100 00100000

Hamming distance is 3
</code></pre>

<p>Basing on this I implemented an additional method <code>Fingerprint#compare(fingerprint)</code>
that calculates similarity in range from 0 to 1.</p>

<h2>Create RSpec matcher</h2>

<p>Now I could compare raw audio data, but in real world almost always we have to have a deal
with compressed audio like mp3 or ogg. However wav files contain exactly raw audio data.
So I could convert compressed audio to wav, then read it to get raw audio and
calculate fingerprints for comparison. To convert audio I prefer using <code>sox</code>
command line tool, it&#8217;s pretty powerful.</p>

<p>I have to explain that I did it all to avoid having a deal with
audio codecs within ruby, since it would make things be much more complicated.</p>

<p>Finally I got <code>sound_like</code> RSpec matcher:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Compare sound of two audio files.</span>
</span><span class='line'><span class="c1"># Based on the Chromaprint library and the +sox+ command like tool.</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># @example</span>
</span><span class='line'><span class="c1">#   &quot;/Airborne.mp3&quot;.should sound_like &quot;/ACDC.mp3&quot;</span>
</span><span class='line'><span class="c1">#   &quot;/Children_of_Bodom.mp3&quot;.should_not sound_like &quot;/Britney_Spears.mp3&quot;</span>
</span><span class='line'><span class="ss">RSpec</span><span class="p">:</span><span class="ss">:Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:sound_like</span> <span class="k">do</span> <span class="o">|</span><span class="n">expected_file</span><span class="o">|</span>
</span><span class='line'>  <span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
</span><span class='line'>    <span class="n">rate</span>      <span class="o">=</span> <span class="mi">96000</span>
</span><span class='line'>    <span class="n">channels</span>  <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="n">threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">95</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">expected_file</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>      <span class="c1"># Convert input files into raw 16-bit signed audio (WAV) to</span>
</span><span class='line'>      <span class="c1"># process with Chromaprint:</span>
</span><span class='line'>      <span class="n">sox_command</span>    <span class="o">=</span> <span class="s2">&quot;sox %s -e signed -b 16 -t wav - &quot;</span> <span class="p">\</span>
</span><span class='line'>                       <span class="s2">&quot;rate </span><span class="si">#{</span><span class="n">rate</span><span class="si">}</span><span class="s2"> channels </span><span class="si">#{</span><span class="n">channels</span><span class="si">}</span><span class="s2"> 2&gt; /dev/null&quot;</span>
</span><span class='line'>      <span class="n">expected_audio</span> <span class="o">=</span> <span class="sx">%x&quot;</span><span class="si">#{</span><span class="n">sox_command</span> <span class="o">%</span> <span class="o">[</span><span class="n">expected_file</span><span class="o">]</span><span class="si">}</span><span class="sx">&quot;</span>
</span><span class='line'>      <span class="n">audio</span>          <span class="o">=</span> <span class="sx">%x&quot;</span><span class="si">#{</span><span class="n">sox_command</span> <span class="o">%</span> <span class="o">[</span><span class="n">file</span><span class="o">]</span><span class="si">}</span><span class="sx">&quot;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Get audio fingerprints:</span>
</span><span class='line'>      <span class="n">chromaprint</span> <span class="o">=</span> <span class="ss">Chromaprint</span><span class="p">:</span><span class="ss">:Context</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
</span><span class='line'>      <span class="n">expected_fp</span> <span class="o">=</span> <span class="n">chromaprint</span><span class="o">.</span><span class="n">get_fingerprint</span><span class="p">(</span><span class="n">expected_audio</span><span class="p">)</span>
</span><span class='line'>      <span class="n">fp</span>          <span class="o">=</span> <span class="n">chromaprint</span><span class="o">.</span><span class="n">get_fingerprint</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Compare fingerprints and compare result against threshold:</span>
</span><span class='line'>      <span class="n">expected_fp</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="kp">false</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that I used threshold with value 0.95 because quite rare fingerprints
have 100% match.</p>

<h2>Links</h2>

<ul>
<li><a href="https://github.com/TMXCredit/chromaprint">Chromaprint ruby port on github</a></li>
<li><a href="http://acoustid.org/chromaprint">Chromaprint web page</a></li>
<li><a href="http://en.wikipedia.org/wiki/Acoustic_fingerprint">Acoustic fingerprint in Wikipedia</a></li>
<li><a href="http://en.wikipedia.org/wiki/Hamming_distance">Hamming distance in Wikipedia</a></li>
<li><a href="http://stackoverflow.com/a/6397116/1013173">Most efficient way to calculate Hamming distance in ruby</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Working with fonts in Debian and Ubuntu]]></title>
    <link href="http://greyblake.com/blog/2013/10/08/working-with-fonts-in-debian-and-ubuntu/"/>
    <updated>2013-10-08T00:43:00+02:00</updated>
    <id>http://greyblake.com/blog/2013/10/08/working-with-fonts-in-debian-and-ubuntu</id>
    <content type="html"><![CDATA[<h2>Install fonts</h2>

<p>There are a lot of fonts in standard Debian repository. Packages which contains
fonts starts with <code>fonts-</code>, so lets install them all. Run the next command as
root:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>apt-cache search ^fonts- | sed <span class="s1">&#39;s/^\(fonts-[^ ]*\).*$/\1/&#39;</span> | xargs apt-get install
</span></code></pre></td></tr></table></div></figure>


<p>Short explanation of the command:</p>

<ul>
<li><code>apt-cache search ^fonts-</code> - find all packages which starts with <code>fonts-</code>;</li>
<li><code>sed 's/^\(fonts-[^ ]*\).*$/\1/'</code> - filter output to get only package names;</li>
<li><code>xargs apt-get install</code> - pass package names to <code>apt-get install</code> to install them.</li>
</ul>


<h2>Preview fonts</h2>

<p>Now you have more than 1500 fonts, but it&#8217;s hard to pick one that you need, because
it&#8217;s hard to look through all of them. For our luck there exist specials to preview
fonts, and one of is called <code>fontmatrix</code>. Lets install it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>apt-get install fontmatrix
</span></code></pre></td></tr></table></div></figure>


<p>And run it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>fontmatrix
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://i1078.photobucket.com/albums/w484/greyblake/fontmatrix.png" alt="Fontmatrix" /></p>

<p>Now it&#8217;s much easier to select right font!:)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to call bash(not shell) from ruby]]></title>
    <link href="http://greyblake.com/blog/2013/09/21/how-to-call-bash-not-shell-from-ruby/"/>
    <updated>2013-09-21T21:53:00+02:00</updated>
    <id>http://greyblake.com/blog/2013/09/21/how-to-call-bash-not-shell-from-ruby</id>
    <content type="html"><![CDATA[<p>Few days ago I was writing a ruby wrapper for <a href="http://sox.sourceforge.net/">SoX</a>
command line tool. To reduce disk IO I wanted to use <a href="http://en.wikipedia.org/wiki/Process_substitution">process substitution</a>.
It&#8217;s a cool shell feature which allows to use command output as an input file for another command.
It&#8217;s pretty useful if the second command doesn&#8217;t work with standard input or you need
to pass more than 1 input.</p>

<p>Let me show the classic example(works in bash and zsh):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat &lt;<span class="o">(</span><span class="nb">echo</span> <span class="s1">&#39;Saluton!&#39;</span><span class="o">)</span> &lt;<span class="o">(</span><span class="nb">echo</span> <span class="s1">&#39;Kiel vi fartas?&#39;</span><span class="o">)</span>
</span><span class='line'><span class="c"># =&gt; Saluton! Kiel vi fartas?</span>
</span></code></pre></td></tr></table></div></figure>


<p>So statement <code>&lt;(echo 'Saluton!')</code> is treated like a file which contains line <code>Saluton!</code>.
Underhood bash(zsh) creates a named pipeline where output of <code>echo 'Saluton!'</code> is written.
Then the named pipeline is passed to <code>cat</code> command.</p>

<p>You can see it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span>  &lt;<span class="o">(</span><span class="nb">echo</span> <span class="s1">&#39;Saluton!&#39;</span><span class="o">)</span>
</span><span class='line'><span class="c"># =&gt; /dev/fd/63</span>
</span></code></pre></td></tr></table></div></figure>


<p>So I wanted to use it in ruby:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;cat &lt;(echo &#39;Saluton!&#39;) &lt;(echo &#39;Kiel vi fartas?&#39;)&quot;</span>
</span><span class='line'><span class="nb">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>But unfortunately it doesn&#8217;t work:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">sh</span><span class="p">:</span> <span class="mi">1</span><span class="p">:</span> <span class="no">Syntax</span> <span class="ss">error</span><span class="p">:</span> <span class="s2">&quot;(&quot;</span> <span class="n">unexpected</span>
</span></code></pre></td></tr></table></div></figure>


<p>The problem is that ruby&#8217;s <code>system</code> method and back quotes use<code>sh</code>
not your current shell (which in my case is <code>bash</code>).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">system</span> <span class="s2">&quot;echo $0&quot;</span>
</span><span class='line'><span class="c1"># =&gt; sh</span>
</span></code></pre></td></tr></table></div></figure>


<p>In shells <code>$0</code>points to the current script or to interpreter if you&#8217;re running it interactively.</p>

<p>Fortunately there is a way to create a workaround to run bash:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;shellwords&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">bash</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>  <span class="n">escaped_command</span> <span class="o">=</span> <span class="no">Shellwords</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">system</span> <span class="s2">&quot;bash -c </span><span class="si">#{</span><span class="n">escaped_command</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Bash has option <code>-c</code> which takes bash script to execute.
<a href="http://www.ruby-doc.org/stdlib-2.0/libdoc/shellwords/rdoc/Shellwords.html">Shellwords</a>
is a standard ruby library which provides a method to escape shell commands.</p>

<p>So now it works as we want it to be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">bash</span><span class="p">(</span><span class="s2">&quot;echo $0&quot;</span><span class="p">)</span>  <span class="c1"># =&gt; bash</span>
</span><span class='line'><span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;cat &lt;(echo &#39;Saluton!&#39;) &lt;(echo &#39;Kiel vi fartas?&#39;)&quot;</span>
</span><span class='line'><span class="n">bash</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>        <span class="c1"># =&gt; Saluton! Kiel vi fartas?</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thanks for reading!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Validation in rails with Themis]]></title>
    <link href="http://greyblake.com/blog/2013/08/19/validation-in-rails-with-themis/"/>
    <updated>2013-08-19T17:21:00+02:00</updated>
    <id>http://greyblake.com/blog/2013/08/19/validation-in-rails-with-themis</id>
    <content type="html"><![CDATA[<p>Sometimes ActiveRecord is not enough to meet complicated validation needs.
At <a href="http://tmxcredit.com/">TMXCredit</a> we&#8217;ve created <a href="https://github.com/TMXCredit/themis">Themis</a> -
ActiveRecord extension which helps to organize validations in a better way and adds
some flexibility. Here I&#8217;m gonna describe some problems which Themis solves after that
I&#8217;ll take a brief look at possible alternative solutions.</p>

<h2>Modular validation</h2>

<p>Themis allows you to extract duplicated validations into module for reuse.
Usually rails applications are small enough so you don&#8217;t need it. But sometimes
you do.</p>

<p>The next example is pretty flat(in real life you probably would use STI or composition to
represent <code>Doctor</code> and <code>Patient</code> models) but it illustrates where Themis could be useful.</p>

<p>Let&#8217;s say you have 2 models:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Doctor</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:diploma</span><span class="p">,</span>
</span><span class='line'>            <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Patient</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:age</span><span class="p">,</span>
</span><span class='line'>            <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>You see that both models have the same validation for <code>first_name</code>, <code>last_name</code> and <code>email</code>.</p>

<p>Themis allows you to fix the duplication problem by extracting common validations into
a module:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Module with common validations.</span>
</span><span class='line'><span class="k">module</span> <span class="nn">PersonValidation</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="ss">Themis</span><span class="p">:</span><span class="ss">:Validation</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Doctor</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="c1"># import validation of first_name, last_name, email</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">PersonValidation</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:diploma</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Patient</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">PersonValidation</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:age</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<!--more-->


<p>So now we keep the common validation in one place.
If you want, you can include validation modules into each other to combine
necessary validation.</p>

<h2>Validation scenarios</h2>

<p>Here is another problem which Themis solves.</p>

<p>We have the following models:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">has_one</span> <span class="ss">:person</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:user_accounts</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:birhday</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:user</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">UserAccount</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:login</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:user</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So we have a model graph like this with <code>User</code> model on the top:</p>

<p><img src="http://i1078.photobucket.com/albums/w484/greyblake/themis_model_graph.png" alt="Themis - model graph" /></p>

<p>It&#8217;s pretty small, but in real life the graph can be much deeper.</p>

<p>What would you do if you needed to apply different validations depending on context?
For example according to your business requirements users must be allowed to use
your application only in case if they&#8217;ve filled in all of the fields.
So you need to validate presense of <code>first_name</code>, <code>last_name</code> and <code>birhday</code>
on <code>Person</code> model and <code>email</code>, <code>login</code> and <code>password</code> on <code>UserAccount</code>.</p>

<p>It&#8217;s not a problem, just add the validations to appropriate models:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:layout</span><span class="p">,</span> <span class="ss">:birhday</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">UserAccount</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:login</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is some percent of users who don&#8217;t finish registration process.
But your marketing department wants to have an ability to contact them
if they have entered an email address.</p>

<p>So that&#8217;s where the issue is: you can&#8217;t save records using validation rules written above.</p>

<p>With Themis you can declare number of validation strategies,
and depending on context, chose which one you need.</p>

<p>Here is how a complete solution looks:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">has_one</span> <span class="ss">:person</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:user_accounts</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">accepts_nested_attributes_for</span> <span class="ss">:person</span><span class="p">,</span> <span class="ss">:user_accounts</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Declare validations. Use :full as default.</span>
</span><span class='line'>  <span class="n">has_validation</span> <span class="ss">:full</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">has_validation</span> <span class="ss">:partial</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:birhday</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:user</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Declare full validation</span>
</span><span class='line'>  <span class="n">has_validation</span> <span class="ss">:full</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span>
</span><span class='line'>    <span class="n">model</span><span class="o">.</span><span class="n">validates</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:birhday</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Delcare partial validation. Nothing to validate.</span>
</span><span class='line'>  <span class="n">has_validation</span> <span class="ss">:partial</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">UserAccount</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:login</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">has_validation</span> <span class="ss">:full</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span>
</span><span class='line'>    <span class="n">model</span><span class="o">.</span><span class="n">validates</span> <span class="ss">:login</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">has_validation</span> <span class="ss">:partial</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span>
</span><span class='line'>    <span class="n">model</span><span class="o">.</span><span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here is how you would use it somewhere in a controller:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Create model initialized with params</span>
</span><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
</span><span class='line'>  <span class="ss">:person</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:first_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Alex&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:last_name</span>  <span class="o">=&gt;</span> <span class="s2">&quot;DeLarge&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:birhday</span>    <span class="o">=&gt;</span> <span class="s2">&quot;1962&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="ss">:user_accounts</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="p">{</span>
</span><span class='line'>    <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;clockwork@orange.com&quot;</span>
</span><span class='line'>  <span class="p">}</span><span class="o">]</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">valid?</span> <span class="c1"># =&gt; false, because login is missing</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Try to apply partial validation</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">use_validation</span><span class="p">(</span><span class="ss">:partial</span><span class="p">)</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">valid?</span> <span class="c1"># =&gt; true</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># We can save it</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">save!</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Alternative solutions</h2>

<p>If you think Themis is overkill for your project, you still have some options.</p>

<h3>Using ActiveSupport::Concern for modularity</h3>

<p><code>ActiveSupport::Concern</code> is another way which allows to extract common validations
into module. Here how would <code>PersonValidation</code> module described above could look:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">PersonValidation</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Concern</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">validates</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Using conditional validation</h3>

<p>If your requirements aren&#8217;t so fancy, you can be satisfied with a simple
conditional validation, e. g.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:birhday</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>            <span class="ss">:if</span> <span class="o">=&gt;</span> <span class="ss">:use_full_validation?</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Lets add one more validation statement(for the next example)</span>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:length</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">255</span> <span class="p">},</span>
</span><span class='line'>            <span class="ss">:if</span> <span class="o">=&gt;</span> <span class="ss">:use_full_validation?</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">use_full_validation?</span>
</span><span class='line'>    <span class="c1"># Some logic goes here</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To DRY up <code>:if</code> options it&#8217;s good to use <code>with_options</code> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">with_options</span> <span class="ss">:if</span> <span class="o">=&gt;</span> <span class="ss">:use_full_validation?</span> <span class="k">do</span> <span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>    <span class="n">person</span><span class="o">.</span><span class="n">validates</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:birhday</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>    <span class="n">person</span><span class="o">.</span><span class="n">validates</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:length</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">255</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now <code>:if =&gt; :use_full_validation</code> will be additonaly passed to every method call
on <code>person</code> inside the block.</p>

<h3>Vanguard</h3>

<p>The guys from <a href="http://rom-rb.org/">the ROM project</a> have their own validator called
<a href="https://github.com/mbj/vanguard">Vanguard</a>(previous name is Aqeuitas).
The sweet thing about it is that it allows to seperate validations and
models according to DataMapper approach. The downside is if you use ActiveRecord
you&#8217;ll have a zoo of validation tools. Also it may be still raw and I&#8217;m not sure
is it possible to apply it to solve the described problem, but I&#8217;d encourage
you to take a look at it.</p>

<h2>Conclusion</h2>

<p>ActiveRecord is good for plain and straightforward projects.
In big enterprise applications usually we need more flexibility to meet different
exotic requiments.
We&#8217;ve created <a href="https://github.com/TMXCredit/themis">Themis</a> to extend ActiveRecord
and solve some of the problems.
Actually I hope that <a href="http://rom-rb.org/">ROM</a> will be ready soon and we&#8217;ll
have an ability to select right ORM before diving into development.</p>

<p>Thanks for reading. Hope the article was useful for you and I&#8217;m wating for
your feedback!</p>

<h2>Links</h2>

<ul>
<li><a href="https://github.com/TMXCredit/themis">Themis on Github</a> - you&#8217;ll find here comprehensive documentation in README;</li>
<li><a href="http://guides.rubyonrails.org/active_record_validations.html#conditional-validation">Conditional validation</a> - extraction from Rails Guide;</li>
<li><a href="https://github.com/mbj/vanguard">Vanguard on Github</a> - validator for ROM project;</li>
<li><a href="http://railscasts.com/episodes/42-with-options">Railscast: #42</a> - Ryan Bates describes how <code>with_options</code> works.</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Почему я изучаю Эсперанто]]></title>
    <link href="http://greyblake.com/blog/2013/03/30/pochiemu-ia-izuchaiu-esperanto/"/>
    <updated>2013-03-30T01:54:00+01:00</updated>
    <id>http://greyblake.com/blog/2013/03/30/pochiemu-ia-izuchaiu-esperanto</id>
    <content type="html"><![CDATA[<p>Как вы знаете, я начал изучать Эсперанто, некоторым даже успел &#8220;съесть&#8221; мозг, но всё же большинство по-прежнему задают вопросы почему и для чего я это делаю. Из этого можно прийти к выводу, что либо я безумен, либо я понимаю что-то, что другие не могут понять.
Поэтому я решил написать небольшую статью и постараться объясниться.</p>

<!--more-->


<h2>Эсперанто? Зачем?</h2>

<p>Прежде всего, когда я рассказываю друзьям и другим людям про Эсперанто, я встречаю одну из следующих реакций:</p>

<ul>
<li>Зачем? Все ведь все говорят на английском.</li>
<li>Фууу! Как это отвратительно! Искусственный язык!</li>
<li>Так это же мёртвый язык!</li>
<li>Оу! Круто чувак! А я вот нашёл новый рецепт итальянских печенек, пойдём покажу, как они готовятся&#8230; (абстрактный ответ друзей, которые не критикуют, но и не хотят разделять моё новое хобби:) ).</li>
</ul>


<h3>Английский не походит на роль международного языка</h3>

<p>Английский плохо подходит на роль международного языка потому что:
* Он более сложен в изучении, и менее информативен чем Эсперанто.
* Он не является нейтральным языком для всех (люди, для которых этот язык является родным имеют языковое преимущество в переговорах).
* В конце концов английский не всегда был таким популярным (раньше подобное положение занимали французкий и немецкий языки) и не всегда будет. Хотя ему повезло больше, потому что его популярность совпала с развитием цифровых технологий.</p>

<h3>Искусственный язык?</h3>

<p>В искусственных языках нету ничего плохого. Некоторые люди утверждают, что они не являются &#8220;природными&#8221;. Но многие национальные языки подвергались/подвергаются реформам, что тоже не является &#8220;природным&#8221;. К примеру современный турецкий язык появился в 20-х годах 20-го столетия в процессе языковой реформы. Таким образом он является на 40 лет моложе Эсперанто, но это никак не мешает туркам общаться. Другой пример - Нюрнорск, современный литературный норвежский язык. Он был сформирован в 19-ом столетии одним человеком на основе существующих диалектов.</p>

<h3>Мёртвый язык?</h3>

<p>Мёртвый язык - это язык, носителей которого практически не осталось. В мире же по разным подсчётам насчитывают от 100 тысяч до 2-3 миллионов носителей языка. Кроме того издаётся порядка ста периодических изданий, на нём вещают радио, пишут книги, проводят международные встречи.</p>

<p>Более детальные и убедительные аргументы вы можете, при желании, с лёгкостью найти в Интернете.
В частности советую <a href="http://www.youtube.com/watch?v=_YHALnLV9XU">посмотреть видео</a>,
где профессиональный лингвист  Клод Пирон объясняет, почему Эсперанто лучше подходит на роль
международного языка.</p>

<h2>Почему изучаю Эсперанто я</h2>

<p>Теперь я попробую рассказать, о языке более субъективно, о том, как его воспринимаю я.</p>

<p>Первый раз, когда я узнал про Эсперанто(случайно в википедии), я просто удивился. Прочитав несколько грамматических правил за пару минут, я не мог понять, почему люди его не используют! У меня появилось ощущение, что мир движется просто не в том направлении. Люди думают &#8220;я не буду учить этот язык, на нём мало кто разговаривает&#8221;. По моим наблюдениям, люди часто учат какой-нибудь другой национальный язык, но используют его намного меньше, чем эсперантисты используют Эсперанто. Получилось так, что мне хватило идеализма начать изучать это лингвистическое творение (так же, как перейти когда-то на Linux, Vim и т.д.;) ).</p>

<p>Как компьютерный инженер, я просто получаю огромное удовольствие от того, как этот язык устроен. Я бы сказал &#8220;спроектирован&#8221;, но боюсь не всем понравится это слово. Это нечто, сделанное очень хорошо, продумано, сделано таким образом, чтобы этим было максимально удобно и легко пользоваться.</p>

<p>Я воспринимаю Эсперанто, как один из следующих витков развития общества. Когда-то в Европе использовались римские цифры, но в конце концов европейцы устали насиловать свой мозг арефметическими операциями сложения и умножения и перешли на арабские(индийские), работать с которыми намного проще. Надеюсь, нечто подобное произойдёт и с языками.</p>

<p>К тому же идея искусственного языка для международного общения далеко не нова: были языки до появления Эсперанто(Сольресоль, Волаплюк, и т.д.) и после(Идо, Окциденталь, и т.д.). Но Эсперанто - единственный, который прошёл испытание временем и по-прежнему успешно развивается.</p>

<p>Этот язык открывает невероятную возможность для путешествия благодаря <a href="http://ru.wikipedia.org/wiki/Pasporta_Servo">Pasporta Servo</a>.
Кроме этого у Эсперанто есть сообщество - умные и весёлые люди, с которыми просто интересно и приятно общаться =)</p>

<h2>Полезные ссылки</h2>

<p>Если после у вас появилось желание изучать этот удивительный язык, вот несколько интернет-ресурсов, которые могут вам в этом помочь:</p>

<ul>
<li><a href="http://www.kurso.com.br/index.php?ru">Kurso de Esperanto</a> - Замечательный курс в виде компьютерной программы, состоит из 12 уроков. Советую начать с него.</li>
<li><a href="http://lernu.net">Lernu.net</a> - Онлайн курс, переведённый на множество язык в том числе и русский</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Install more screensavers on Mate desktop]]></title>
    <link href="http://greyblake.com/blog/2013/02/02/install-more-screensavers-on-mate-desktop/"/>
    <updated>2013-02-02T22:24:00+01:00</updated>
    <id>http://greyblake.com/blog/2013/02/02/install-more-screensavers-on-mate-desktop</id>
    <content type="html"><![CDATA[<p>I switched from Gnome3 to <a href="http://mate-desktop.org/">Mate desktop</a>
and noticed that I&#8217;m able to use only few sreensavers.
If you&#8217;re using Mate (it&#8217;s default for Linux Mint) you might experience the same problem.</p>

<p>There is a workaround how to use much more screensavers with Mate as usually able
to do with Gnome.</p>

<p>Install packages with additional screensavers:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apt-get install xscreensaver-data-extra xscreensaver-gl-extra</span></code></pre></td></tr></table></div></figure>


<p>Go to <code>/usr/share/applications/screensavers</code> directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd /usr/share/applications/screensavers</span></code></pre></td></tr></table></div></figure>


<p>There are located number of <code>.desktop</code> files. You should edit them by replacing the line</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>OnlyShowIn=GNOME;</span></code></pre></td></tr></table></div></figure>


<p>with</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>OnlyShowIn=GNOME;MATE;</span></code></pre></td></tr></table></div></figure>


<p>.</p>

<p>Obviously it&#8217;s a routine to change them all manually. So use <code>sed</code> tool to edit all files in once:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>find . -name <span class="s1">&#39;*.desktop&#39;</span> | xargs sed -i <span class="s1">&#39;s/OnlyShowIn=GNOME;/OnlyShowIn=GNOME;MATE;/&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now you are able to use more than hundred screensavers on Mate!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Failed to add new printer in Debian Wheezy]]></title>
    <link href="http://greyblake.com/blog/2013/01/27/failed-to-add-new-printer-in-debian-wheezy/"/>
    <updated>2013-01-27T21:44:00+01:00</updated>
    <id>http://greyblake.com/blog/2013/01/27/failed-to-add-new-printer-in-debian-wheezy</id>
    <content type="html"><![CDATA[<p>After migrating to Debian Wheezy (current test Debian repository) I faced a problem
with installing a local USB printer: on attempt to add new USB printer
(HP LaserJet M1005) I got an error message: &#8220;Failed to add new printer in Debian Wheezy&#8221;
(&#8220;Не удалось добавить новый принтер&#8221; if you have Russian localization).</p>

<p>After googling for I a while I found a good workaround for it. All you need is
to use <code>pk-helper</code> package from Sid (unstable Debian version), since it seems to
be buggy in Wheezy.</p>

<p>So add Sid repository to your <code>/etc/apt/source.list</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>deb http://ftp.ua.debian.org/debian/ sid main non-free contrib</span></code></pre></td></tr></table></div></figure>


<p>And reinstall <code>cups-pk-helper</code> package using Sid repository:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aptitude reinstall cups-pk-helper --target sid</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s all. Now try to connect your USB printer.
Btw, there is the <a href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=695131">bug report</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rational can't be coerced into BigDecimal in ruby 1.9.3]]></title>
    <link href="http://greyblake.com/blog/2012/12/20/rational-cant-be-coerced-into-bigdecimal-in-ruby-1-dot-9-3/"/>
    <updated>2012-12-20T16:34:00+01:00</updated>
    <id>http://greyblake.com/blog/2012/12/20/rational-cant-be-coerced-into-bigdecimal-in-ruby-1-dot-9-3</id>
    <content type="html"><![CDATA[<p>Trying to move a rails application from ruby 1.8.7 to 1.9.3 I ran into coercion
issue of <code>Rational</code> class.</p>

<p>Ruby 1.9.3:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;bigdecimal&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rational&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># You can multiply Rational against BigDecimal</span>
</span><span class='line'><span class="no">Rational</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="no">BigDecimal</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>  <span class="c1"># =&gt; &lt;BigDecimal:a566d0,&#39;0.1E1&#39;,9(36)&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># But you can&#39;t do the same when you change order</span>
</span><span class='line'><span class="no">BigDecimal</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="no">Rational</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># =&gt; TypeError: Rational can&#39;t be coerced into BigDecimal</span>
</span></code></pre></td></tr></table></div></figure>


<p>On other hand in Ruby 1.8.7:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;bigdecimal&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rational&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># BigDecimal * Rational works OK</span>
</span><span class='line'><span class="no">BigDecimal</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="no">Rational</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># =&gt; 1.0 (Float)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># But Rational * BigDecimal doesn&#39;t</span>
</span><span class='line'><span class="no">Rational</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="no">BigDecimal</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>  <span class="c1"># =&gt; TypeError: Rational can&#39;t be coerced into BigDecimal</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s looks weird. So I can only say for sure that <code>Rational</code> -> <code>BigDecimal</code>
coercion is not implemented in Ruby.</p>

<p>I&#8217;ve tried to fix it with simple monkey patch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Works only for Ruby1.9.3</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Rational</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">coerce</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">value</span>
</span><span class='line'>    <span class="k">when</span> <span class="no">BigDecimal</span>
</span><span class='line'>      <span class="k">return</span> <span class="nb">self</span><span class="p">,</span> <span class="n">value</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="k">super</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And it works OK against simple examples:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Rational</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="no">BigDecimal</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>  <span class="c1"># =&gt; &lt;BigDecimal:a566d0,&#39;0.1E1&#39;,9(36)&gt;</span>
</span><span class='line'><span class="no">BigDecimal</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="no">Rational</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># =&gt; &lt;BigDecimal:a566d0,&#39;0.1E1&#39;,9(36)&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>But it causes intermittent segmentation faults when I run Rails application.</p>

<p>Any ideas about the coercion? Is it expected behaviour of ruby1.9.3?
I found no bugs reported this issue on
<a href="bugs.ruby-lang.org">https://bugs.ruby-lang.org</a>.</p>

<p>I&#8217;ll appreciate any feedback. Thanks.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Custom expectations with RSpec]]></title>
    <link href="http://greyblake.com/blog/2012/12/14/custom-expectations-with-rspec/"/>
    <updated>2012-12-14T00:34:00+01:00</updated>
    <id>http://greyblake.com/blog/2012/12/14/custom-expectations-with-rspec</id>
    <content type="html"><![CDATA[<p>I know you love RSpec&#8217;s <code>expect</code> DSL like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">expect</span> <span class="p">{</span> <span class="k">raise</span><span class="p">(</span><span class="s2">&quot;Boom!&quot;</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="no">RuntimeError</span><span class="p">,</span> <span class="s2">&quot;Boom!&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We often write our own custom matchers and I wanna show how is easy to write
custom expectation.</p>

<h2>Desired DSL</h2>

<p>Usually when I do things like this I start with DSL. I think it&#8217;s important since
it must be convenient to use and easy to read.
So turn on your imagination and spend some time on it.</p>

<p>In my example I&#8217;m gonna create an expectation to test text written to standard output
and standard error.
There are samples how I wanna use it(desired DSL):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Test text written to standard output</span>
</span><span class='line'><span class="n">expect</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s2">&quot;Hello!&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">write</span><span class="p">(</span><span class="s2">&quot;Hello!&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Test text written to standard error</span>
</span><span class='line'><span class="n">expect</span> <span class="p">{</span> <span class="nb">warn</span> <span class="s2">&quot;Stop it!&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">write</span><span class="p">(</span><span class="s2">&quot;Stop it!&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="ss">:error</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<!--more-->


<h2>Expectation</h2>

<p>I bet you&#8217;ve already created number of custom matchers. What about custom expectations?
They are usual custom matches which test blocks of code!</p>

<p>I&#8217;m gonna locate the expectation in <code>spec/support/custom_expectations/write_expectation.rb</code> file.
I think <code>spec/support/custom_expectations/</code> directory is the right place for it since
custom matchers usually are located in <code>spec/support/custom_matchers/</code>.</p>

<p>So finally the expectation looks this way:</p>

<figure class='code'><figcaption><span>spec/support/custom_expectations/write_expectation.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">RSpec</span><span class="o">::</span><span class="no">Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:write</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
</span><span class='line'>  <span class="n">chain</span><span class="p">(</span><span class="ss">:to</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
</span><span class='line'>    <span class="vi">@io</span> <span class="o">=</span> <span class="n">io</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">block</span><span class="o">|</span>
</span><span class='line'>    <span class="n">output</span> <span class="o">=</span>
</span><span class='line'>      <span class="k">case</span> <span class="n">io</span>
</span><span class='line'>      <span class="k">when</span> <span class="ss">:output</span> <span class="k">then</span> <span class="n">fake_stdout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="k">when</span> <span class="ss">:error</span>  <span class="k">then</span> <span class="n">fake_stderr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span> <span class="k">raise</span><span class="p">(</span><span class="s2">&quot;Allowed values for `to` are :output and :error, got `</span><span class="si">#{</span><span class="n">io</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="n">output</span><span class="o">.</span><span class="n">include?</span> <span class="n">message</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">description</span> <span class="k">do</span>
</span><span class='line'>    <span class="s2">&quot;write </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> </span><span class="si">#{</span><span class="n">io_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">failure_message_for_should</span> <span class="k">do</span>
</span><span class='line'>    <span class="s2">&quot;expected to </span><span class="si">#{</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">failure_message_for_should_not</span> <span class="k">do</span>
</span><span class='line'>    <span class="s2">&quot;expected to not </span><span class="si">#{</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Fake STDERR and return a string written to it.</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">fake_stderr</span>
</span><span class='line'>    <span class="n">original_stderr</span> <span class="o">=</span> <span class="vg">$stderr</span>
</span><span class='line'>    <span class="vg">$stderr</span> <span class="o">=</span> <span class="no">StringIO</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="k">yield</span>
</span><span class='line'>    <span class="vg">$stderr</span><span class="o">.</span><span class="n">string</span>
</span><span class='line'>  <span class="k">ensure</span>
</span><span class='line'>    <span class="vg">$stderr</span> <span class="o">=</span> <span class="n">original_stderr</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Fake STDOUT and return a string written to it.</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">fake_stdout</span>
</span><span class='line'>    <span class="n">original_stdout</span> <span class="o">=</span> <span class="vg">$stdout</span>
</span><span class='line'>    <span class="vg">$stdout</span> <span class="o">=</span> <span class="no">StringIO</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="k">yield</span>
</span><span class='line'>    <span class="vg">$stdout</span><span class="o">.</span><span class="n">string</span>
</span><span class='line'>  <span class="k">ensure</span>
</span><span class='line'>    <span class="vg">$stdout</span> <span class="o">=</span> <span class="n">original_stdout</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># default IO is standard output</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">io</span>
</span><span class='line'>    <span class="vi">@io</span> <span class="o">||=</span> <span class="ss">:output</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># IO name is used for description message</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">io_name</span>
</span><span class='line'>    <span class="p">{</span><span class="ss">:output</span> <span class="o">=&gt;</span> <span class="s2">&quot;standard output&quot;</span><span class="p">,</span> <span class="ss">:error</span> <span class="o">=&gt;</span> <span class="s2">&quot;standard error&quot;</span><span class="p">}</span><span class="o">[</span><span class="n">io</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that&#8217;s it. You can try it against the examples from &#8220;Desired DSL&#8221; section.</p>

<p>Hope that&#8217;s was useful. I look forward for your comments and suggestions. You know I do! =)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[pg_power - ActiveRecord extension for PostgreSQL]]></title>
    <link href="http://greyblake.com/blog/2012/09/06/pg-power-activerecord-extension-for-postgresql/"/>
    <updated>2012-09-06T23:24:00+02:00</updated>
    <id>http://greyblake.com/blog/2012/09/06/pg-power-activerecord-extension-for-postgresql</id>
    <content type="html"><![CDATA[<p>I am happy to announce that  <a href="http://tmxcredit.com/">TMXCredit</a> released
<a href="https://github.com/TMXCredit/pg_power">pg_power</a> gem - an ActiveRecord extension which
allows to use number of PostgreSQL features with Rails.</p>

<h2>What you can do with pg_power?</h2>

<ul>
<li>Use PostgresSQL schemas in your Rails project.</li>
<li>Add comments to PostgreSQL database with Rails migrations.</li>
<li>Use foreign keys (we imported foreigner functionality and made it schema aware).</li>
<li>Use partial indexes.</li>
<li>Add indexes concurrently.</li>
</ul>


<p>You&#8217;ll find enough documentation in <a href="https://github.com/TMXCredit/pg_power/blob/master/README.markdown">README</a>
file.</p>

<h2>Quick usage example</h2>

<p>Assume you want to create tables <code>countries</code> and <code>languages</code> in <code>demography</code> schema.</p>

<p>At first we need to create <code>demography</code> schema:</p>

<figure class='code'><figcaption><span>db/migrate/create_demography_schema.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreateDemographySchema</span> <span class="o">&lt;</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="n">create_schema</span> <span class="s1">&#39;demography&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&#8217;s create tables:</p>

<figure class='code'><figcaption><span>db/migrate/create_demography_languages.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreateDemographyLanguages</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="c1"># Create table `languages` in schema `demography`</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="s2">&quot;languages&quot;</span><span class="p">,</span> <span class="ss">:schema</span> <span class="o">=&gt;</span> <span class="s2">&quot;demography&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:code</span><span class="p">,</span> <span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">2</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Add PostgreSQL comments</span>
</span><span class='line'>    <span class="n">set_table_comment</span> <span class="s2">&quot;demography.languages&quot;</span><span class="p">,</span> <span class="s2">&quot;List of languages&quot;</span>
</span><span class='line'>    <span class="n">set_column_comments</span> <span class="s2">&quot;demography.languages&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Full name of language in English&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">:code</span> <span class="o">=&gt;</span> <span class="s2">&quot;ISO 639-1 code&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>db/migrate/create_demography_countries.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreateDemographyContries</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="c1"># Create table `countries` in schema `demography`</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="s2">&quot;countries&quot;</span><span class="p">,</span> <span class="ss">:schema</span> <span class="o">=&gt;</span> <span class="s2">&quot;demography&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># In real life you likely would have many-to-many associaton</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:language_id</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Add PostgreSQL comments</span>
</span><span class='line'>    <span class="n">set_table_comment</span> <span class="s2">&quot;demography.countries&quot;</span><span class="p">,</span> <span class="s2">&quot;List of world countries&quot;</span>
</span><span class='line'>    <span class="n">set_column_comments</span> <span class="s2">&quot;demography.languages&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">:name</span>        <span class="o">=&gt;</span> <span class="s2">&quot;Full name of country in English&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">:language_id</span> <span class="o">=&gt;</span> <span class="s2">&quot;Most popular language in the country&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Add foreign key and create index on demography.countries.language_id</span>
</span><span class='line'>    <span class="n">add_foreign_key</span><span class="p">(</span><span class="s2">&quot;demography.countries&quot;</span><span class="p">,</span> <span class="s2">&quot;demography.languages&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Great! Now we need to set table names in models to make ActiveRecord know that
these tables are located in <code>demography</code> schema.</p>

<figure class='code'><figcaption><span>app/models/language.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Language</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">set_table_name</span> <span class="s2">&quot;demography.languages&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It will work. But I would recommend you to create module <code>Demography</code> which would represent
<code>demography</code> schema and move those models to it. One more benefit is that you can define
schema prefix in module and models will use it build table name automatically.</p>

<figure class='code'><figcaption><span>app/models/demography.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Demography</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">table_name_prefix</span>
</span><span class='line'>    <span class="s1">&#39;demography.&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/models/demography/language.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Demography::Language</span>
</span><span class='line'>  <span class="c1"># No need to use set_table_name anymore</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I hope you will enjoy <a href="https://github.com/TMXCredit/pg_power">pg_power</a>. Let us know what you think!</p>

<p>Thanks. Sergey Potapov.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby performance tricks]]></title>
    <link href="http://greyblake.com/blog/2012/09/02/ruby-perfomance-tricks/"/>
    <updated>2012-09-02T23:34:00+02:00</updated>
    <id>http://greyblake.com/blog/2012/09/02/ruby-perfomance-tricks</id>
    <content type="html"><![CDATA[<p>I did some benchmarks to find out which alternatives to write code work faster. I wanna
share it with you. All benchmarks are made against ruby 1.9.3p194 MRI.</p>

<h2>Do not use exceptions for a control flow</h2>

<p>The next example is pretty stupid but it shows how exceptions slow against
conditional statements.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Obj</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">with_condition</span>
</span><span class='line'>    <span class="nb">respond_to?</span><span class="p">(</span><span class="ss">:mythical_method</span><span class="p">)</span> <span class="p">?</span> <span class="nb">self</span><span class="o">.</span><span class="n">mythical_method</span> <span class="p">:</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">with_rescue</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">mythical_method</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="no">NoMethodError</span>
</span><span class='line'>    <span class="kp">nil</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">obj</span> <span class="o">=</span> <span class="no">Obj</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">N</span> <span class="o">=</span> <span class="mi">10_000_000</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="no">RUBY_DESCRIPTION</span>
</span><span class='line'>
</span><span class='line'><span class="no">Benchmark</span><span class="o">.</span><span class="n">bm</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;rescue/condition&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>  <span class="n">rescue_report</span>     <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;rescue:&quot;</span><span class="p">)</span>    <span class="p">{</span> <span class="n">N</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">obj</span><span class="o">.</span><span class="n">with_rescue</span>    <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">condition_report</span>  <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;condition:&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">N</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">obj</span><span class="o">.</span><span class="n">with_condition</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>  <span class="o">[</span><span class="n">rescue_report</span> <span class="o">/</span> <span class="n">condition_report</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>MRI 1.9.3:</p>

<pre><code>ruby 1.9.3p194 (2012-04-20 revision 35410) [x86_64-linux]
                        user     system      total        real
rescue:           111.530000   2.650000 114.180000 (115.837103)
condition:          2.620000   0.010000   2.630000 (  2.633154)
rescue/condition:  42.568702 265.000000        NaN ( 43.991767)
</code></pre>

<p>MRI 1.8.7 (REE has similar result):</p>

<pre><code>ruby 1.8.7 (2011-12-28 patchlevel 357) [x86_64-linux]
                        user     system      total        real
rescue:            80.510000   0.940000  81.450000 ( 81.529022)
if:                 3.320000   0.000000   3.320000 (  3.330166)
rescue/condition:  24.250000        inf       -nan ( 24.481970)
</code></pre>

<!--more-->


<h2>String concatenation</h2>

<p>Avoid using <code>+=</code> to concatenate strings in favor of <code>&lt;&lt;</code> method.
The result is absolutely the same: add a string to the end of an existing one.
What is the difference then?</p>

<p>See the example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">str1</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span>
</span><span class='line'><span class="n">str2</span> <span class="o">=</span> <span class="s2">&quot;second&quot;</span>
</span><span class='line'><span class="n">str1</span><span class="o">.</span><span class="n">object_id</span>       <span class="c1"># =&gt; 16241320</span>
</span><span class='line'>
</span><span class='line'><span class="n">str1</span> <span class="o">+=</span> <span class="n">str2</span>    <span class="c1"># str1 = str1 + str2</span>
</span><span class='line'><span class="n">str1</span><span class="o">.</span><span class="n">object_id</span>  <span class="c1"># =&gt; 16241240, id is changed</span>
</span><span class='line'>
</span><span class='line'><span class="n">str1</span> <span class="o">&lt;&lt;</span> <span class="n">str2</span>
</span><span class='line'><span class="n">str1</span><span class="o">.</span><span class="n">object_id</span>  <span class="c1"># =&gt; 16241240, id is the same</span>
</span></code></pre></td></tr></table></div></figure>


<p>When you use <code>+=</code> ruby creates a temporal object which is result of <code>str1 + str2</code>.
Then it overrides <code>str1</code> variable with reference to the new built object.
On other hand <code>&lt;&lt;</code> modifies existing one.</p>

<p>As a result of using <code>+=</code> you have the next disadvantages:</p>

<ul>
<li>More calculation to join strings.</li>
<li>Redundant string object in memory (previous value of <code>str1</code>), which approximates time when
<a href="http://en.wikipedia.org/wiki/Garbage_collection_%28computer_science%29">GC</a> will trigger.</li>
</ul>


<p>How <code>+=</code> is slow? Basically it depends on length of strings you have operation with.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">N</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span class='line'><span class="no">BASIC_LENGTH</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class='line'>
</span><span class='line'><span class="mi">5</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">factor</span><span class="o">|</span>
</span><span class='line'>  <span class="n">length</span> <span class="o">=</span> <span class="no">BASIC_LENGTH</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">factor</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;_&quot;</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">LENGTH: </span><span class="si">#{</span><span class="n">length</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Benchmark</span><span class="o">.</span><span class="n">bm</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;+= VS &lt;&lt;&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>    <span class="n">concat_report</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;+=&quot;</span><span class="p">)</span>  <span class="k">do</span>
</span><span class='line'>      <span class="n">str1</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>      <span class="n">str2</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span> <span class="o">*</span> <span class="n">length</span>
</span><span class='line'>      <span class="n">N</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">str1</span> <span class="o">+=</span> <span class="n">str2</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">modify_report</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;&quot;</span><span class="p">)</span>  <span class="k">do</span>
</span><span class='line'>      <span class="n">str1</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span>
</span><span class='line'>      <span class="n">str2</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span> <span class="o">*</span> <span class="n">length</span>
</span><span class='line'>      <span class="n">N</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">str1</span> <span class="o">&lt;&lt;</span> <span class="n">str2</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">[</span><span class="n">concat_report</span> <span class="o">/</span> <span class="n">modify_report</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Output:</p>

<pre><code>____________________________________________________________
LENGTH: 10
                 user     system      total        real
+=           0.000000   0.000000   0.000000 (  0.004671)
&lt;&lt;           0.000000   0.000000   0.000000 (  0.000176)
+= VS &lt;&lt;          NaN        NaN        NaN ( 26.508796)
____________________________________________________________
LENGTH: 100
                 user     system      total        real
+=           0.020000   0.000000   0.020000 (  0.022995)
&lt;&lt;           0.000000   0.000000   0.000000 (  0.000226)
+= VS &lt;&lt;          Inf        NaN        NaN (101.845829)
____________________________________________________________
LENGTH: 1000
                 user     system      total        real
+=           0.270000   0.120000   0.390000 (  0.390888)
&lt;&lt;           0.000000   0.000000   0.000000 (  0.001730)
+= VS &lt;&lt;          Inf        Inf        NaN (225.920077)
____________________________________________________________
LENGTH: 10000
                 user     system      total        real
+=           3.660000   1.570000   5.230000 (  5.233861)
&lt;&lt;           0.000000   0.010000   0.010000 (  0.015099)
+= VS &lt;&lt;          Inf 157.000000        NaN (346.629692)
____________________________________________________________
LENGTH: 100000
                 user     system      total        real
+=          31.270000  16.990000  48.260000 ( 48.328511)
&lt;&lt;           0.050000   0.050000   0.100000 (  0.105993)
+= VS &lt;&lt;   625.400000 339.800000        NaN (455.961373)
</code></pre>

<h2>Be careful with calculation within iterators</h2>

<p>Assume you need to write a function to convert an array into a hash
where keys and values are same as elements of the array:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">func</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span><span class="p">)</span>  <span class="c1"># =&gt; {1 =&gt; 1, 2 =&gt; 2, 3 =&gt; 3}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next solution would satisfy the requirements:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'>  <span class="n">array</span><span class="o">.</span><span class="n">inject</span><span class="p">({})</span> <span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span> <span class="n">e</span><span class="o">|</span> <span class="n">h</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">e</span> <span class="o">=&gt;</span> <span class="n">e</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And would be extremely slow with big portions of data because it contains
nested methods (<code>inject</code> and <code>merge</code>), so it&#8217;s <strong> O(n<sup>2</sup>) </strong> algorithm.
But it&#8217;s obviously that it must be <strong> O(n) </strong>.
Consider the next:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'>  <span class="n">array</span><span class="o">.</span><span class="n">inject</span><span class="p">({})</span> <span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span> <span class="n">e</span><span class="o">|</span> <span class="n">h</span><span class="o">[</span><span class="n">e</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span> <span class="n">h</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case we do only one iteration over an array without any hard calculation
within the iterator.</p>

<p>See the benchmark:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">n_func</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'>  <span class="n">array</span><span class="o">.</span><span class="n">inject</span><span class="p">({})</span> <span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span> <span class="n">e</span><span class="o">|</span> <span class="n">h</span><span class="o">[</span><span class="n">e</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span> <span class="n">h</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">n2_func</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'>  <span class="n">array</span><span class="o">.</span><span class="n">inject</span><span class="p">({})</span> <span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span> <span class="n">e</span><span class="o">|</span> <span class="n">h</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">e</span> <span class="o">=&gt;</span> <span class="n">e</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">BASE_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class='line'>
</span><span class='line'><span class="mi">4</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">factor</span><span class="o">|</span>
</span><span class='line'>  <span class="n">size</span>   <span class="o">=</span> <span class="no">BASE_SIZE</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">factor</span><span class="p">)</span>
</span><span class='line'>  <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.size</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;_&quot;</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SIZE: </span><span class="si">#{</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="no">Benchmark</span><span class="o">.</span><span class="n">bm</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>    <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;O(n)&quot;</span> <span class="p">)</span> <span class="p">{</span> <span class="n">n_func</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>  <span class="p">}</span>
</span><span class='line'>    <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;O(n2)&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">n2_func</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Output:</p>

<pre><code>____________________________________________________________
SIZE: 10
                user     system      total        real
O(n)        0.000000   0.000000   0.000000 (  0.000014)
O(n2)       0.000000   0.000000   0.000000 (  0.000033)
____________________________________________________________
SIZE: 100
                user     system      total        real
O(n)        0.000000   0.000000   0.000000 (  0.000043)
O(n2)       0.000000   0.000000   0.000000 (  0.001070)
____________________________________________________________
SIZE: 1000
                user     system      total        real
O(n)        0.000000   0.000000   0.000000 (  0.000347)
O(n2)       0.130000   0.000000   0.130000 (  0.127638)
____________________________________________________________
SIZE: 10000
                user     system      total        real
O(n)        0.020000   0.000000   0.020000 (  0.019067)
O(n2)      17.850000   0.080000  17.930000 ( 17.983827)
</code></pre>

<p>It&#8217;s an obvious and trivial example. Just keep in mind to not do
hard calculation within iterators if it&#8217;s possible.</p>

<h2>Use bang! methods</h2>

<p>In many cases bang methods do the same as there non-bang analogues but without
duplication an object. The previous example with <code>merge!</code> would be much faster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">merge!</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'>  <span class="n">array</span><span class="o">.</span><span class="n">inject</span><span class="p">({})</span> <span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span> <span class="n">e</span><span class="o">|</span> <span class="n">h</span><span class="o">.</span><span class="n">merge!</span><span class="p">(</span><span class="n">e</span> <span class="o">=&gt;</span> <span class="n">e</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'>  <span class="n">array</span><span class="o">.</span><span class="n">inject</span><span class="p">({})</span> <span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span> <span class="n">e</span><span class="o">|</span> <span class="n">h</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">e</span> <span class="o">=&gt;</span> <span class="n">e</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">N</span> <span class="o">=</span> <span class="mi">10_000</span>
</span><span class='line'><span class="n">array</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.N</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
</span><span class='line'>
</span><span class='line'><span class="no">Benchmark</span><span class="o">.</span><span class="n">bm</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;merge!&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">merge!</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;merge&quot;</span><span class="p">)</span>  <span class="p">{</span> <span class="n">merge</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Output:</p>

<pre><code>                 user     system      total        real
merge!       0.010000   0.000000   0.010000 (  0.011370)
merge       17.710000   0.000000  17.710000 ( 17.840856)
</code></pre>

<h2>Use instance variables</h2>

<p>Accessing instance variable directly is about two times faster than accessing
them with accessor methods:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Metric</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:var</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@n</span>   <span class="o">=</span> <span class="n">n</span>
</span><span class='line'>    <span class="vi">@var</span> <span class="o">=</span> <span class="mi">22</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">run</span>
</span><span class='line'>    <span class="no">Benchmark</span><span class="o">.</span><span class="n">bm</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>      <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;@var&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="vi">@n</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="vi">@var</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;var&quot;</span> <span class="p">)</span> <span class="p">{</span> <span class="vi">@n</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">var</span>  <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;@var =&quot;</span><span class="p">)</span>     <span class="p">{</span> <span class="vi">@n</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span><span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="vi">@var</span> <span class="o">=</span> <span class="n">i</span>     <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;self.var =&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="vi">@n</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span><span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="nb">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">i</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">metric</span> <span class="o">=</span> <span class="no">Metric</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">100_000_000</span><span class="p">)</span>
</span><span class='line'><span class="n">metric</span><span class="o">.</span><span class="n">run</span>
</span></code></pre></td></tr></table></div></figure>


<p>Output:</p>

<pre><code>                 user     system      total        real
@var         6.980000   0.010000   6.990000 (  7.193725)
var         13.040000   0.000000  13.040000 ( 13.131711)
@var =       7.960000   0.000000   7.960000 (  8.242603)
self.var =  14.910000   0.010000  14.920000 ( 15.960125)
</code></pre>

<h2>Parallel assignment is slower</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">N</span> <span class="o">=</span> <span class="mi">10_000_000</span>
</span><span class='line'>
</span><span class='line'><span class="no">Benchmark</span><span class="o">.</span><span class="n">bm</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s1">&#39;parallel&#39;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">N</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s1">&#39;consequentially&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>    <span class="n">N</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class='line'>      <span class="n">b</span> <span class="o">=</span> <span class="mi">20</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Output:</p>

<pre><code>                      user     system      total        real
parallel          1.900000   0.000000   1.900000 (  1.928063)
consequentially   0.880000   0.000000   0.880000 (  0.879675)
</code></pre>

<h2>Dynamic method defention</h2>

<p>What is the faster way to define method dynamically: <code>class_eval</code> with a code string
or using <code>define_method</code>? Which way generated methods work faster?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Metric</span>
</span><span class='line'>  <span class="n">N</span> <span class="o">=</span> <span class="mi">1_000_000</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">class_eval_with_string</span>
</span><span class='line'>    <span class="n">N</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">class_eval</span><span class="p">(</span><span class="o">&lt;&lt;-</span><span class="no">eorb</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">,</span> <span class="bp">__LINE__</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="sh">        def smeth_#{i}</span>
</span><span class='line'><span class="sh">          #{i}</span>
</span><span class='line'><span class="sh">        end</span>
</span><span class='line'><span class="no">      eorb</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">with_define_method</span>
</span><span class='line'>    <span class="n">N</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>      <span class="n">define_method</span><span class="p">(</span><span class="s2">&quot;dmeth_</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">i</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Benchmark</span><span class="o">.</span><span class="n">bm</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;class_eval with string&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="no">Metric</span><span class="o">.</span><span class="n">class_eval_with_string</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;define_method&quot;</span><span class="p">)</span>          <span class="p">{</span> <span class="no">Metric</span><span class="o">.</span><span class="n">with_define_method</span>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">metric</span> <span class="o">=</span> <span class="no">Metric</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;string method&quot;</span><span class="p">)</span>  <span class="p">{</span> <span class="no">Metric</span><span class="o">::</span><span class="n">N</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">metric</span><span class="o">.</span><span class="n">smeth_1</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;dynamic method&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="no">Metric</span><span class="o">::</span><span class="n">N</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">metric</span><span class="o">.</span><span class="n">dmeth_1</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Output:</p>

<pre><code>                             user     system      total        real
class_eval with string 219.840000   0.720000 220.560000 (221.933074)
define_method           61.280000   0.240000  61.520000 ( 62.070911)
string method            0.110000   0.000000   0.110000 (  0.111433)
dynamic method           0.150000   0.000000   0.150000 (  0.156537)
</code></pre>

<p>So <code>class_eval</code> works slower but it&#8217;s preferred since methods generated with
<code>class_eval</code> and a string of code work faster.</p>

<h2>Links</h2>

<ul>
<li><a href="http://www.simonecarletti.com/blog/2010/01/how-slow-are-ruby-exceptions/">How Slow Are Ruby Exceptions</a></li>
<li><a href="http://www.igvita.com/2008/07/08/6-optimization-tips-for-ruby-mri/">6 Optimization Tips for Ruby MRI</a>
(NOTE: <code>Symbol#to_proc</code> was ported to Ruby and it&#8217;s not slow anymore)</li>
<li><a href="http://my.safaribooksonline.com/book/web-development/ruby/9780321540034">&#8220;Writing Efficient Ruby Code&#8221; by Dr. Stefan Kaes</a></li>
<li><a href="http://programmingzen.com/2007/02/10/top-10-ruby-on-rails-performance-tips/">Top 10 Ruby on Rails performance tips </a></li>
<li><a href="http://blog.monitis.com/index.php/2012/02/08/20-ruby-performance-tips/">20 Ruby Performance Tips</a></li>
<li><a href="http://rob-bell.net/2009/06/a-beginners-guide-to-big-o-notation/">A Beginner’s Guide to Big O Notation</a></li>
</ul>


<p>Danke.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Unexpected Ruby behaviour]]></title>
    <link href="http://greyblake.com/blog/2012/08/10/unexpected-ruby-behaviour/"/>
    <updated>2012-08-10T23:28:00+02:00</updated>
    <id>http://greyblake.com/blog/2012/08/10/unexpected-ruby-behaviour</id>
    <content type="html"><![CDATA[<p>Ruby is a cool language with intuitive grammar. However there are a number of things which don&#8217;t seem to be expected.
It might take long hours to debug some weird issues for unenlightened newbies.</p>

<!--more-->


<h2>Implicitly variable declaration</h2>

<p>Variable mentioned in conditional block of code become declared and initialized with <code>nil</code> even if the declaration was not executed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="kp">false</span>
</span><span class='line'>  <span class="n">var</span> <span class="o">=</span> <span class="s2">&quot;never executed&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">var</span> <span class="c1"># =&gt; nil</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Expected:</strong> addressing to <code>var</code> raises <code>NameError: undefined local variable or method 'var'</code></p>

<h2>Calling #utc and #gmt on Time object removes time zone information</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">t</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">new</span>  <span class="c1"># =&gt; Sat Aug 11 01:11:52 +0300 2012</span>
</span><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">utc</span>         <span class="c1"># =&gt; Fri Aug 10 22:11:52 UTC 2012</span>
</span><span class='line'><span class="n">t</span>             <span class="c1"># =&gt; Fri Aug 10 22:11:52 UTC 2012, WTF? O_o</span>
</span><span class='line'>
</span><span class='line'><span class="n">t</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">new</span>  <span class="c1"># =&gt; Sat Aug 11 01:17:06 +0300 2012</span>
</span><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">gmtime</span>      <span class="c1"># =&gt; Fri Aug 10 22:17:06 UTC 2012</span>
</span><span class='line'><span class="n">t</span>             <span class="c1"># =&gt; Fri Aug 10 22:17:06 UTC 2012, WTF? O_o</span>
</span></code></pre></td></tr></table></div></figure>


<p>IMHO, this methods should be called <code>utc!</code> and <code>gmtime!</code> instead.
I have an experience when it caused a really voodoo thing: a test failed only from 20:00 to 00:00
in USA on CI server, and could never be reproduced in my time zone.</p>

<p>Instead it&#8217;s better to use <code>getutc</code> and <code>getgm</code> methods which return UTC and GMT time accordingly,
but don&#8217;t change Time object:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">t</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">new</span>  <span class="c1"># =&gt; Sat Aug 11 01:11:52 +0300 2012</span>
</span><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">getutc</span>      <span class="c1"># =&gt; Fri Aug 10 22:11:52 UTC 2012</span>
</span><span class='line'><span class="n">t</span>             <span class="c1"># =&gt; Sat Aug 11 01:11:52 +0300 2012</span>
</span><span class='line'>
</span><span class='line'><span class="n">t</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">new</span>  <span class="c1"># =&gt; Sat Aug 11 01:17:06 +0300 2012</span>
</span><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">getgm</span>       <span class="c1"># =&gt; Fri Aug 10 22:17:06 UTC 2012</span>
</span><span class='line'><span class="n">t</span>             <span class="c1"># =&gt; Sat Aug 11 01:17:06 +0300 2012</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Methods do not return value from ensure statement</h2>

<p>Usually ruby methods return the value of the last method line unless <code>return</code> is called explicitly.
But how about this?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">run</span>
</span><span class='line'>  <span class="mi">1</span>
</span><span class='line'><span class="k">ensure</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;ensure block...&quot;</span>
</span><span class='line'>  <span class="mi">2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">run</span> <span class="c1"># =&gt; 1</span>
</span><span class='line'><span class="c1"># pints `ensure block...`</span>
</span></code></pre></td></tr></table></div></figure>


<p>So if you want to return a value from <code>ensure</code> statement use <code>return</code> word:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">run</span>
</span><span class='line'>  <span class="mi">1</span>
</span><span class='line'><span class="k">ensure</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">run</span> <span class="c1"># =&gt; 2</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Anchors ^ and $ do not mean a start and an end of a string</h2>

<p>Most of script languages uses anchors <code>^</code> and <code>$</code> of regular expressions as a start and an end of string accordingly.
But not in Ruby! In Ruby they are a start and an end of a <strong>line</strong>.
See the difference:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">pattern</span>      <span class="o">=</span> <span class="sr">/^[a-zA-Z]{3,12}$/</span>    <span class="c1"># 3-12 alphabetic characters</span>
</span><span class='line'><span class="n">valid_name</span>   <span class="o">=</span> <span class="s2">&quot;Tatiana&quot;</span>
</span><span class='line'><span class="n">invalid_name</span> <span class="o">=</span> <span class="s2">&quot;23</span><span class="se">\n</span><span class="s2">abc</span><span class="se">\n</span><span class="s2">!&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">valid_name</span>   <span class="o">=~</span> <span class="n">pattern</span>   <span class="c1"># =&gt; 0, matchers</span>
</span><span class='line'><span class="n">invalid_name</span> <span class="o">=~</span> <span class="n">pattern</span>   <span class="c1"># =&gt; 3, matchers</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instead use <code>\A</code> and <code>\z</code> anchors. They are a start and an end of a <strong>string</strong>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">pattern</span>      <span class="o">=</span> <span class="sr">/\A[a-zA-Z]{3,12}\z/</span>    <span class="c1"># 3-12 alphabetic characters</span>
</span><span class='line'><span class="n">valid_name</span>   <span class="o">=</span> <span class="s2">&quot;Tatiana&quot;</span>
</span><span class='line'><span class="n">invalid_name</span> <span class="o">=</span> <span class="s2">&quot;23</span><span class="se">\n</span><span class="s2">abc</span><span class="se">\n</span><span class="s2">!&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">valid_name</span>   <span class="o">=~</span> <span class="n">pattern</span>   <span class="c1"># =&gt; 0, matchers</span>
</span><span class='line'><span class="n">invalid_name</span> <span class="o">=~</span> <span class="n">pattern</span>   <span class="c1"># =&gt; nil</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pay attention when you write validations.
<a href="http://homakov.blogspot.com/2012/05/saferweb-injects-in-various-ruby.html">Read Egor Homakov&#8217;s article</a>
to get more information about it.</p>

<h2>\m regexp option</h2>

<p>When other languages use <code>\s</code> option to make <code>.</code> match newline, Ruby uses <code>\m</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">=~</span> <span class="sr">/./</span>   <span class="c1"># =&gt; nil</span>
</span><span class='line'> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">=~</span> <span class="sr">/./m</span>  <span class="c1"># =&gt; 0</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Calling super and super() are not the same</h2>

<p>There is no matter for ruby methods do you use parentheses or not. But be careful with <code>super</code>
since it&#8217;s not a method, but a key word.
Let me show an example when parentheses matter:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Parent</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">m1</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Parent m1: arg = </span><span class="si">#{</span><span class="n">arg</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">m2</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Parent m2: arg = </span><span class="si">#{</span><span class="n">arg</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Child</span> <span class="o">&lt;</span> <span class="no">Parent</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">m1</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Child m1: arg = </span><span class="si">#{</span><span class="n">arg</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">super</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">m2</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Child m2: arg = </span><span class="si">#{</span><span class="n">arg</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">super</span><span class="p">()</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">child</span> <span class="o">=</span> <span class="no">Child</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">child</span><span class="o">.</span><span class="n">m1</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">child</span><span class="o">.</span><span class="n">m2</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Output:</p>

<pre><code>Child m1: arg = "foo"
Parent m1: arg = "foo"
Child m2: arg = "bar"
super.rb:6:in `m2': wrong number of arguments (0 for 1) (ArgumentError)
        from super.rb:19:in `m2'
        from super.rb:25:in `&lt;main&gt;'
</code></pre>

<p>When you use <code>super</code> it calls same method of parent class passing same arguments to it.
But when you use <code>super(...)</code> you have to pass arguments manually. In my example <code>ArgumentError</code>
was raised because <code>Parent#m2</code> expects to receive exactly one argument, but nothing was passed to <code>super()</code></p>

<p>However <code>super()</code> still delegates a passed block. If you don&#8217;t wanna pass
a block you have to do it explicitly using <code>super(&amp;nil)</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Parent</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">m1</span>
</span><span class='line'>    <span class="k">yield</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">m2</span>
</span><span class='line'>    <span class="k">yield</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Child</span> <span class="o">&lt;</span> <span class="no">Parent</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">m1</span>
</span><span class='line'>    <span class="k">super</span><span class="p">()</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">m2</span>
</span><span class='line'>    <span class="k">super</span><span class="p">(</span><span class="o">&amp;</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">child</span> <span class="o">=</span> <span class="no">Child</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">child</span><span class="o">.</span><span class="n">m1</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s2">&quot;Hi, m1&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="n">child</span><span class="o">.</span><span class="n">m2</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s2">&quot;Hi, m2&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Output:</p>

<pre><code>Hi, m1
/tmp/super.rb:7:in `m2': no block given (yield) (LocalJumpError)
</code></pre>

<h2>lambda and Proc.new act differently</h2>

<p>It&#8217;s a well known thing but I want to remind.
There 2 differences between proc objects created with <code>lambda</code> and <code>Proc.new</code>:</p>

<ul>
<li><code>lambda</code> raises <code>ArgumentError</code> if parameter is missing when <code>Proc.new</code> uses <code>nil</code> instead.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">lm</span> <span class="o">=</span> <span class="nb">lambda</span>   <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">a</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> and </span><span class="si">#{</span><span class="n">b</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="n">pr</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">a</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> and </span><span class="si">#{</span><span class="n">b</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">lm</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># =&gt; ArgumentError: wrong number of arguments (1 for 2)</span>
</span><span class='line'><span class="n">pr</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># =&gt; &quot;10 and nil&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>For <code>lambda</code> word <code>return</code> means returning from proc object, when for <code>Proc.new</code> it means returning from scope where proc is defined.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">lambda_method</span>
</span><span class='line'>  <span class="n">lm</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">10</span> <span class="p">}</span>     <span class="c1"># return from lambda</span>
</span><span class='line'>  <span class="n">half</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>  <span class="n">half</span> <span class="o">*</span> <span class="mi">2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">proc_method</span>
</span><span class='line'>  <span class="n">pr</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">10</span> <span class="p">}</span>   <span class="c1"># return from proc_method</span>
</span><span class='line'>  <span class="n">half</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>  <span class="n">half</span> <span class="o">*</span> <span class="mi">2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">lambda_method</span>   <span class="c1"># =&gt; 20</span>
</span><span class='line'><span class="n">proc_method</span>     <span class="c1"># =&gt; 10</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note there is also method <code>proc</code>. In Ruby 1.8 it&#8217;s a synonym for <code>lambda</code>
but in Ruby 1.9 it&#8217;s a synonym for <code>Proc.new</code>. So avoid using <code>proc</code> to keep you code compatible
for both ruby versions.</p>

<h2>DelegateClass instance does not eql itself</h2>

<p>Ruby standard library provides <a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/delegate/rdoc/Object.html">DelegateClass</a>
which can be <a href="http://pivotallabs.com/users/jdean/blog/articles/1138-delegateclass-rocks-my-world">pretty useful</a>.
But some things are not so obvious about it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;delegate&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Animal</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Dog</span> <span class="o">&lt;</span> <span class="no">DelegateClass</span><span class="p">(</span><span class="no">Animal</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">animal</span> <span class="o">=</span> <span class="no">Animal</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">dog</span> <span class="o">=</span> <span class="no">Dog</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">animal</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">dog</span><span class="o">.</span><span class="n">eql?</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span>  <span class="c1"># =&gt; false, WTF? O_o</span>
</span></code></pre></td></tr></table></div></figure>


<p>It happens because <code>eql?</code> is delegated to base object(animal):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">dog</span><span class="o">.</span><span class="n">eql?</span><span class="p">(</span><span class="n">animal</span><span class="p">)</span>  <span class="c1"># =&gt; true</span>
</span></code></pre></td></tr></table></div></figure>


<p>On other hand <code>equal?</code> is not:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">dog</span><span class="o">.</span><span class="n">equal?</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span>     <span class="c1"># =&gt; true</span>
</span><span class='line'><span class="n">dog</span><span class="o">.</span><span class="n">equal?</span><span class="p">(</span><span class="n">animal</span><span class="p">)</span>  <span class="c1"># =&gt; false</span>
</span></code></pre></td></tr></table></div></figure>


<h2>dup method do not work for all objects</h2>

<p>As you might know every object in Ruby has <a href="http://ruby-doc.org/core-1.9.3/Object.html#method-i-dup">dup</a>
method inherited from <code>Object</code> class. It&#8217;s convenient, I like it. But <strong>it does not mean that every object
can be duplicated</strong>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="ss">:symbol</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="kp">false</span><span class="o">].</span><span class="n">all?</span> <span class="p">{</span> <span class="o">|</span><span class="n">obj</span><span class="o">|</span> <span class="n">obj</span><span class="o">.</span><span class="n">respond_to?</span> <span class="ss">:dup</span> <span class="p">}</span> <span class="c1"># =&gt; true</span>
</span><span class='line'><span class="ss">:symbol</span><span class="o">.</span><span class="n">dup</span>   <span class="c1"># =&gt; TypeError: can&#39;t dup Symbol</span>
</span><span class='line'><span class="kp">true</span><span class="o">.</span><span class="n">dup</span>      <span class="c1"># =&gt; TypeError: can&#39;t dup TrueClass</span>
</span><span class='line'><span class="kp">false</span><span class="o">.</span><span class="n">dup</span>     <span class="c1"># =&gt; TypeError: can&#39;t dup FalseClass</span>
</span></code></pre></td></tr></table></div></figure>


<p>It means you can&#8217;t make a deep copy of an array (with one level depth) like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">copy</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:dup</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Or like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">copy</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">val</span><span class="o">|</span> <span class="n">val</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:dup</span><span class="p">)</span> <span class="p">?</span> <span class="n">val</span><span class="o">.</span><span class="n">dup</span> <span class="p">:</span> <span class="n">val</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since all your objects respond to <code>#dup</code>.</p>

<p>ActiveSupport provides <code>duplicable?</code> method to inspect an ability
to duplicate an object, so finally your solution would look the next way:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">copy</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">val</span><span class="o">|</span> <span class="n">val</span><span class="o">.</span><span class="n">duplicable?</span> <span class="p">?</span> <span class="n">val</span><span class="o">.</span><span class="n">dup</span> <span class="p">:</span> <span class="n">val</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Internally ruby symbols and booleans point to constant memory addresses, and
there is no reason to copy them since they are unchangable.
But I wish the implementation of their <code>#dup</code> methods looked like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Symbol</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">dup</span>
</span><span class='line'>    <span class="nb">self</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<br />


<br />


<p>So I hope the article was useful for you.
If you know some fancy Ruby things I haven&#8217;t mentioned please let me know.</p>

<p>Thanks.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to build Vim against specific Ruby version]]></title>
    <link href="http://greyblake.com/blog/2012/07/15/how-to-build-vim-against-specific-ruby-version/"/>
    <updated>2012-07-15T23:00:00+02:00</updated>
    <id>http://greyblake.com/blog/2012/07/15/how-to-build-vim-against-specific-ruby-version</id>
    <content type="html"><![CDATA[<p>Let&#8217;s say you installed your Vim editor as a system package. Likely it was compiled against Ruby 1.8.7.
But what if you need Vim compiled with Ruby 1.9.x?
I&#8217;m gonna tell you how to do it.</p>

<!--more-->


<h2>Clone vim repository</h2>

<p>Make sure you have installed <code>mercurial</code> package:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo apt-get install mercurial
</span></code></pre></td></tr></table></div></figure>


<p>Clone Vim repository from google code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>hg clone https://vim.googlecode.com/hg/ vim_sources
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>vim_sources
</span></code></pre></td></tr></table></div></figure>


<h2>Patching</h2>

<p>There is no option to specify Ruby version to compile Vim against.
But it&#8217;s easy to patch vim sources to force it to use <code>1.9</code> instead of <code>1.8</code>.</p>

<p>Open file <code>src/Make_mvc.mak</code> in vim sources directory.</p>

<p>Find lines like this:</p>

<figure class='code'><figcaption><span>src/Make_mvc.mak</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Support Ruby interface</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="err">!ifdef</span> <span class="err">RUBY</span>
</span><span class='line'><span class="c">#  Set default value</span>
</span><span class='line'><span class="err">!ifndef</span> <span class="err">RUBY_VER</span>
</span><span class='line'><span class="nv">RUBY_VER</span> <span class="o">=</span> 18
</span><span class='line'>!endif
</span><span class='line'>!ifndef RUBY_VER_LONG
</span><span class='line'><span class="nv">RUBY_VER_LONG</span> <span class="o">=</span> 1.8
</span><span class='line'>!endif
</span></code></pre></td></tr></table></div></figure>


<p>Replace <code>18</code> and <code>1.8</code> with <code>19</code> and <code>1.9</code>. So it should look this way:</p>

<figure class='code'><figcaption><span>src/Make_mvc.mak</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Support Ruby interface</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="err">!ifdef</span> <span class="err">RUBY</span>
</span><span class='line'><span class="c">#  Set default value</span>
</span><span class='line'><span class="err">!ifndef</span> <span class="err">RUBY_VER</span>
</span><span class='line'><span class="nv">RUBY_VER</span> <span class="o">=</span> 19
</span><span class='line'>!endif
</span><span class='line'>!ifndef RUBY_VER_LONG
</span><span class='line'><span class="nv">RUBY_VER_LONG</span> <span class="o">=</span> 1.9
</span><span class='line'>!endif
</span></code></pre></td></tr></table></div></figure>


<h2>Configure and compile</h2>

<p>At first make sure your current ruby version is which one you need:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>rvm use 1.9.3 --default
</span><span class='line'><span class="nv">$ </span>ruby -v
</span><span class='line'>ruby 1.9.3p194 <span class="o">(</span>2012-04-20 revision 35410<span class="o">)</span> <span class="o">[</span>x86_64-linux<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>No we are ready to run <code>./configure</code> script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>./configure --enable-rubyinterp<span class="o">=</span>yes --prefix<span class="o">=</span>/where/you/want/ruby/to/be/installed/
</span></code></pre></td></tr></table></div></figure>


<p>If everything is OK we can go ahead and compile it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>make -j 3
</span></code></pre></td></tr></table></div></figure>


<p><code>-j</code> option defines number of processes to make builing faster. It&#8217;s useful if number of CPU cores is greater than one.</p>

<p>Finally install built Vim to <code>/where/you/want/ruby/to/be/installed/</code> directory which you passed as <code>--prefix</code> option:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>make install
</span></code></pre></td></tr></table></div></figure>


<h2>Verify Ruby version</h2>

<p>Now let&#8217;s open your new Vim:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> /where/you/want/ruby/to/be/installed/
</span><span class='line'><span class="nv">$ </span>./bin/vim
</span></code></pre></td></tr></table></div></figure>


<p>And run the next command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="p">:</span><span class="k">ruby</span> puts RUBY_DESCRIPTION
</span></code></pre></td></tr></table></div></figure>


<p>The ouput should looks similar to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="k">ruby</span> <span class="m">1</span>.<span class="m">9</span>.<span class="m">3</span>p<span class="m">194</span> <span class="p">(</span><span class="m">2012-04-20</span> revision <span class="m">35410</span><span class="p">)</span> [x86_64<span class="p">-</span>linux]
</span></code></pre></td></tr></table></div></figure>


<p>So, everything is OK. Enjoy Vim and builtin ruby 1.9 ;)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Тестируем вложенные ActiveRecord-модели с RSpec]]></title>
    <link href="http://greyblake.com/blog/2012/07/06/tiestiruiem-vlojenie-activerecord-modeli-s-rspec/"/>
    <updated>2012-07-06T22:19:00+02:00</updated>
    <id>http://greyblake.com/blog/2012/07/06/tiestiruiem-vlojenie-activerecord-modeli-s-rspec</id>
    <content type="html"><![CDATA[<p>Иногда бывает так, что вам нужно построить большой граф вложенных объектов,
и конечно же протестировать, что ваш &#8220;builder&#8221; работает так, как нужно. На самом деле
задача элементарная, но я всё же попробую поискать наиболее элегантный путь её решения.</p>

<!--more-->


<p>Расмотрим следующий пример, когда у нас есть три небольшие модели: User, Account, Preference.
(На практике обычно моделей намного больше с большим количеством свойств).</p>

<figure class='code'><figcaption><span>user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:first_name</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">has_one</span> <span class="ss">:account</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>account.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:last_visit_date</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:user</span>
</span><span class='line'>  <span class="n">has_one</span> <span class="ss">:preference</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>preference.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Preference</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:language</span><span class="p">,</span> <span class="ss">:weapon</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:user</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Предположим у нас есть некий builder, который строит объект User и все завимимые
модели(Account и Preference). Всё что мы хотим сделать - это протестировать,
что граф объектов построен правильно.</p>

<p>Вот пример реализации стандартного rspec-теста, который первым приходит на ум:</p>

<figure class='code'><figcaption><span>user_builder_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">UserBuilder</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s1">&#39;#build&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">describe</span> <span class="s1">&#39;user&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">described_class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">some_attrs</span><span class="p">)</span><span class="o">.</span><span class="n">build</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">subject</span> <span class="p">{</span> <span class="n">user</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">its</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="s2">&quot;Rodion&quot;</span>      <span class="p">}</span>
</span><span class='line'>      <span class="n">its</span><span class="p">(</span><span class="ss">:last_name</span><span class="p">)</span>  <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="s2">&quot;Raskolnikov&quot;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">describe</span> <span class="s1">&#39;account&#39;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">subject</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">account</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">its</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span>           <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="s2">&quot;rodion@mail.ru&quot;</span>       <span class="p">}</span>
</span><span class='line'>        <span class="n">its</span><span class="p">(</span><span class="ss">:last_visit_date</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="no">Date</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">1866</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">27</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">describe</span> <span class="s1">&#39;preference&#39;</span> <span class="k">do</span>
</span><span class='line'>          <span class="n">subject</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">preference</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">its</span><span class="p">(</span><span class="ss">:language</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="s2">&quot;Russian&quot;</span> <span class="p">}</span>
</span><span class='line'>          <span class="n">its</span><span class="p">(</span><span class="ss">:weapon</span><span class="p">)</span>   <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="s2">&quot;ax&quot;</span>      <span class="p">}</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Всё читаемо, красиво и просто. Но проблема в том, что получилось шесть тестов(по тесту на
каждый атрибут), которые тестируют лишь одно действие - постороение объекта. Когда операция построения
занимает немало времени, а количество атрибутов на порядок больше, такой подход
становится далеко не самым лучшим, поскольку возрастает время выполнения.
Если объект не сохраняется в базе то вполне разумным будет использовать <code>before :all</code>. Но если
вам приходится сохранять объект и вы используете опцию <code>config.use_transactional_fixtures = true</code>,
потому что не хотите &#8220;гадить&#8221; в базу, то этот вариант не подойдёт.</p>

<p>Можно пойти по пути классического unit-тестирования и сделать тест подобным этому:</p>

<figure class='code'><figcaption><span>user_builder_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">UserBuilder</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s1">&#39;#build&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">described_class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">some_attrs</span><span class="p">)</span><span class="o">.</span><span class="n">build</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;should correctly build a user&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="s2">&quot;Rodion&quot;</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="o">.</span><span class="n">should</span>  <span class="o">==</span> <span class="s2">&quot;Raskolnikov&quot;</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">should</span>           <span class="o">==</span> <span class="s2">&quot;rodion@mail.ru&quot;</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">last_visit_date</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="no">Date</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">1866</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">27</span><span class="p">)</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">preference</span><span class="o">.</span><span class="n">language</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="s2">&quot;Russian&quot;</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">preference</span><span class="o">.</span><span class="n">weapon</span><span class="o">.</span><span class="n">should</span>   <span class="o">==</span> <span class="s2">&quot;ax&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Получилось даже лаконичнее, но менее читаемо(уж когда будет больше вложенность объектов,
будет точно менее читаемо). Так же раздрожает длинные цепочки одинаковых методов.</p>

<p>Помедитировав над проблемой, я нашёл компроммиссное решение на основе метода <code>instance_eval</code>.</p>

<figure class='code'><figcaption><span>user_builder_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">UserBuilder</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s1">&#39;#build&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">described_class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">some_attrs</span><span class="p">)</span><span class="o">.</span><span class="n">build</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;should correctly build a user&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">first_name</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="s2">&quot;Rodion&quot;</span>
</span><span class='line'>        <span class="n">last_name</span><span class="o">.</span><span class="n">should</span>  <span class="o">==</span> <span class="s2">&quot;Raskolnikov&quot;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">account</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>          <span class="n">email</span><span class="o">.</span><span class="n">should</span>           <span class="o">==</span> <span class="s2">&quot;rodion@mail.ru&quot;</span>
</span><span class='line'>          <span class="n">last_visit_date</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="no">Date</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">1866</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">27</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">preference</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>            <span class="n">language</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="s2">&quot;Russian&quot;</span>
</span><span class='line'>            <span class="n">weapon</span><span class="o">.</span><span class="n">should</span>   <span class="o">==</span> <span class="s2">&quot;ax&quot;</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Это по-прежнему один тест, но мы избавились от длинных цепочек методов.
Нужно заметить, что у такого подхода есть тоже свои недостатки: используя <code>instance_eval</code>
мы покидаем контекст теста, и переходим прямо в контекст объекта, в котором не существует методов подобных
<code>be_valid</code>, <code>be_instance_of</code>, etc.</p>

<p>Надеюсь, эта идея будет вам полезной. Буду рад узнать чужое мнение.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[I released Smartdict version 0.1.0]]></title>
    <link href="http://greyblake.com/blog/2012/06/11/i-released-smartdict-version-0-dot-1-0/"/>
    <updated>2012-06-11T03:20:00+02:00</updated>
    <id>http://greyblake.com/blog/2012/06/11/i-released-smartdict-version-0-dot-1-0</id>
    <content type="html"><![CDATA[<p>Today I released <a href="http://smartdict.net/blog/2012/06/11/smartdict-0-dot-1-0-is-released/">Smartdict version 0.1.0</a>.
Please give me a favour and check it out.</p>

<p>I&#8217;m gonna implement a vim plugin based on <a href="https://github.com/smartdict/smartdict-core">smartdict-core</a>.
That will the next step in this direction, since I realy need it.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Получаем Premium на busuu.com бесплатно]]></title>
    <link href="http://greyblake.com/blog/2012/05/21/poluchaem-premium-na-busuu-com-besplatno/"/>
    <updated>2012-05-21T17:42:20+02:00</updated>
    <id>http://greyblake.com/blog/2012/05/21/poluchaem-premium-na-busuu-com-besplatno</id>
    <content type="html"><![CDATA[<p>Пожалуйста, прочтитайте так же мою статью <a href="http://greyblake.com/blog/2013/03/30/pochiemu-ia-izuchaiu-esperanto/">Почему я изучаю Эсперанто</a>.</p>

<p>Недавно я начал пользоваться сервисом <a href="http://www.busuu.com">busuu.com</a>. Очень классная вещь, но вот беда: спустя неделю часть функционала перестала работать, предлагая купить Premium аккаунт за 69,99 EUR.</p>

<p>Одна из полезностей которые пропали, была возможность прослушивания ключевых фраз во время изучения новых слов. Кнопка, при нажатие на которую должна произносится фраза, превратилась в обычную ссылку на страницу, которая предлагает купить Premium.</p>

<p><img src="http://i1078.photobucket.com/albums/w484/greyblake/play_button.png" alt="bussu play button" /></p>

<p>Мне стало интересно, а можно ли это обойти? Оказалось, что можно! Файловый сервер, который отдаёт аудио-файлы никак не проверяет права пользователя, а сами ссылки на файлы можно прямо получить из ответов сервера на AJAX-запросы, которые отсылаются при нажатии на следующее/предыдущее слово.</p>

<!--more-->


<p>После полутора часов изучения и дебага родился скрипт, приведенный в конце статьи, который делает то, что мне нужно:</p>

<ul>
<li>Возвращает старую кнопку, вместо ссылки</li>
<li>Переопределяет callback AJAX-запроса так, чтобы он получал из ответа ссылку на аудио-файл.</li>
</ul>


<h2>Как этим воспользоваться?</h2>

<p>Предполагаю, что статью будут читать и нетехнические люди, поэтому опишу в деталях, как использовать эту уязвимость в своё благо.</p>

<h3>Установка Firebug</h3>

<p>Firebug - это расширение для Firefox, которым обычно пользуются веб-разработчики. Вам придётся его установить.
Сделать это можно по <a href="http://getfirebug.com/">этой ссылке</a>, нажав на кнопку &#8220;Install Firebug&#8221;. После чего броузер должен перезагрузиться.</p>

<h3>Основной трюк</h3>

<p>Зайдите на busuu.com на страницу изучения слов. Откройте Firebug.
В моём случае это делается через меню: Tools -> Web Developer -> Firebug -> открыть Firebug. Возможно в разных сборках Firefox, это может быть по-разному.</p>

<p>Откройте консоль и полностью скопируйте в неё Javascript код, приведенный в конце этой статьи, как показано на рисунке. После чего нажмите кнопку &#8220;Выполнить&#8221;.</p>

<p><img src="http://i1078.photobucket.com/albums/w484/greyblake/firebug-1.png" alt="firebug" /></p>

<h3>Изучайте ваш любимый язык</h3>

<p>Дело сделано, вы можете закрыть Firebug. Теперь, кликнув на следующее слово у вас будет возможность прослушать ключевую фразу. Всё это будет работать до тех пор, пока вы не перезагрузите страницу.</p>

<h2>Если у вас не Firefox</h2>

<p>В большинстве других броузеров есть подобные инструменты для отладки, которые позволят вам проделать такой же трюк. Например, в броузере Google Chrome он встроенный, и открывается при нажатии клавиш Ctrl+Shift+J. В видео ниже показано, как именно это делается.</p>

<iframe width="420" height="315" src="http://www.youtube.com/embed/cVn7IkkQFBU" frameborder="0" allowfullscreen></iframe>


<h2>Javascript код</h2>

<figure class='code'><figcaption><span>put it into Firebug console</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Define languages</span>
</span><span class='line'><span class="nx">hack_native_lang</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">hack_matched</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\/(enc|ar|zh|fr|de|it|ja|pl|pt|ru|es|tr)\//</span><span class="p">)</span>
</span><span class='line'><span class="nx">hack_learning_lang</span> <span class="o">=</span> <span class="nx">hack_matched</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Replace link to subsribe with real play button</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">hack_player_div</span> <span class="o">=</span> <span class="s1">&#39;&lt;div id=&quot;player2&quot; class=&quot;busuu-player&quot;&gt;&lt;/div&gt;&#39;</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#kp-audio&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">hack_player_div</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Update onClick event</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#player2&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>   <span class="k">if</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s2">&quot;busuu-player-pause&quot;</span><span class="p">)){</span>
</span><span class='line'>     <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#player&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s2">&quot;jPlayer&quot;</span><span class="p">).</span><span class="nx">status</span><span class="p">.</span><span class="nx">paused</span><span class="p">){</span>
</span><span class='line'>       <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s2">&quot;busuu-player-pause&quot;</span><span class="p">);</span>
</span><span class='line'>       <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#player&quot;</span><span class="p">).</span><span class="nx">jPlayer</span><span class="p">(</span><span class="s2">&quot;pause&quot;</span><span class="p">);</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>     <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>       <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#player&quot;</span><span class="p">).</span><span class="nx">jPlayer</span><span class="p">(</span><span class="s2">&quot;play&quot;</span><span class="p">);</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>   <span class="k">else</span><span class="p">{</span>
</span><span class='line'>     <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#player&quot;</span><span class="p">).</span><span class="nx">jPlayer</span><span class="p">(</span><span class="s2">&quot;setMedia&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">mp3</span><span class="o">:</span><span class="nx">kp_audio</span><span class="p">}).</span><span class="nx">jPlayer</span><span class="p">(</span><span class="s2">&quot;play&quot;</span><span class="p">);</span>
</span><span class='line'>     <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;busuu-player-pause&quot;</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Redefine function getEnt() to make it set global variable kp_audio with link to mp3 file</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">getEnt</span><span class="p">(</span><span class="nx">pl</span><span class="p">,</span><span class="nx">entid</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="nx">p_entid</span> <span class="o">=</span> <span class="p">(</span><span class="nx">entities</span><span class="p">[</span><span class="nx">index</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">entities</span><span class="p">[</span><span class="nx">index</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>   <span class="nx">n_entid</span> <span class="o">=</span> <span class="p">(</span><span class="nx">entities</span><span class="p">[</span><span class="nx">index</span> <span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">entities</span><span class="p">[</span><span class="nx">index</span> <span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>   <span class="k">if</span> <span class="p">(</span><span class="nx">entid</span> <span class="o">==</span> <span class="mi">14069255</span> <span class="o">||</span> <span class="nx">entid</span> <span class="o">==</span> <span class="mi">7312</span> <span class="o">||</span> <span class="nx">entid</span> <span class="o">==</span> <span class="mi">1305</span> <span class="o">||</span> <span class="nx">entid</span> <span class="o">==</span> <span class="mi">3279</span> <span class="o">||</span>
</span><span class='line'>       <span class="nx">entid</span> <span class="o">==</span> <span class="mi">2310</span> <span class="o">||</span> <span class="nx">entid</span> <span class="o">==</span> <span class="mi">81017</span> <span class="o">||</span> <span class="nx">entid</span> <span class="o">==</span> <span class="mi">1450</span> <span class="o">||</span> <span class="nx">entid</span> <span class="o">==</span> <span class="mi">30872</span><span class="p">){</span>
</span><span class='line'>     <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#ge&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">(</span><span class="s2">&quot;drop&quot;</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>   <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#ge&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>   <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>       <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;/js/busuuajax/entity/&quot;</span><span class="o">+</span><span class="nx">entid</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="nx">hack_learning_lang</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="nx">hack_native_lang</span><span class="o">+</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">p_entid</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">n_entid</span><span class="p">,</span>
</span><span class='line'>       <span class="nx">cache</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span>
</span><span class='line'>       <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;xml&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xml</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#report_link&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span> <span class="s2">&quot;/js/busuuajax/user_report_entity/&quot;</span><span class="o">+</span><span class="nx">hack_learning_lang</span><span class="o">+</span><span class="s2">&quot;/1_1_4/&quot;</span><span class="o">+</span><span class="nx">entid</span><span class="o">+</span><span class="s2">&quot;?KeepThis=true&amp;TB_iframe=true&amp;height=270&amp;width=300&quot;</span><span class="p">);</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#star&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span><span class="s2">&quot;http://static3.bscdn.net/sites/all/themes/busuunew/images/star_off.png&quot;</span><span class="p">);</span>
</span><span class='line'>              <span class="nx">already_selected</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">xml</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;flagged&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="nx">already_selected</span> <span class="p">)</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#star&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span><span class="s2">&quot;http://static1.bscdn.net/sites/all/themes/busuunew/images/star_on.png&quot;</span><span class="p">);</span>
</span><span class='line'>              <span class="nx">image</span> <span class="o">=</span> <span class="s2">&quot;&lt;img style=&#39;display:none;&#39; src=&#39;&quot;</span><span class="o">+</span><span class="nx">$</span><span class="p">(</span><span class="nx">xml</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;&#39; /&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>              <span class="nx">prev_image</span><span class="o">=</span><span class="nx">$</span><span class="p">(</span><span class="nx">xml</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;prev_image&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">();</span>
</span><span class='line'>              <span class="nx">next_image</span><span class="o">=</span><span class="nx">$</span><span class="p">(</span><span class="nx">xml</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;next_image&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">();</span>
</span><span class='line'>              <span class="nx">audio</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">xml</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;audio&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">();</span>
</span><span class='line'>              <span class="nx">word1</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">xml</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;value1&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">();</span>
</span><span class='line'>              <span class="nx">word2</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">xml</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;value2&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">();</span>
</span><span class='line'>              <span class="nx">phrase1</span> <span class="o">=</span>  <span class="nx">$</span><span class="p">(</span><span class="nx">xml</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;keyphrase1&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">();</span>
</span><span class='line'>              <span class="nx">phrase2</span><span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">xml</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;keyphrase2&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">();</span>
</span><span class='line'>              <span class="nx">phonetics</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">xml</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;entity_phonetics&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">();</span>
</span><span class='line'>              <span class="k">if</span><span class="p">(</span><span class="nx">phonetics</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>                <span class="nx">entity_phonetics</span> <span class="o">=</span> <span class="s2">&quot;&lt;br&gt;&lt;div dir=\&quot;ltr\&quot; lang=\&quot;enc\&quot; class=\&quot;phonetics\&quot;&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>                <span class="nx">entity_phonetics</span> <span class="o">+=</span> <span class="nx">phonetics</span><span class="p">;</span>
</span><span class='line'>                <span class="nx">entity_phonetics</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="nx">phonetics</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">xml</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;kp_phonetics&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">();</span>
</span><span class='line'>              <span class="k">if</span><span class="p">(</span><span class="nx">phonetics</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>                <span class="nx">kp_phonetics</span> <span class="o">=</span> <span class="s2">&quot;&lt;br&gt;&lt;div dir=\&quot;ltr\&quot; lang=\&quot;enc\&quot; class=\&quot;phonetics\&quot;&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>                <span class="nx">kp_phonetics</span> <span class="o">+=</span>  <span class="nx">phonetics</span><span class="p">;</span>
</span><span class='line'>                <span class="nx">kp_phonetics</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="nx">kp_audio</span><span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">xml</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;kp_audio&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">if</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">platform</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;iPad&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
</span><span class='line'>                  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#player&quot;</span><span class="p">).</span><span class="nx">jPlayer</span><span class="p">(</span><span class="s2">&quot;setMedia&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">mp3</span><span class="o">:</span> <span class="nx">audio</span><span class="p">});</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="k">else</span><span class="p">{</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#player&quot;</span><span class="p">).</span><span class="nx">jPlayer</span><span class="p">(</span><span class="s2">&quot;setMedia&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">mp3</span><span class="o">:</span> <span class="nx">audio</span><span class="p">}).</span><span class="nx">jPlayer</span><span class="p">(</span><span class="s2">&quot;play&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#player1&quot;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;busuu-player-pause&quot;</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">){</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#left&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&lt;img style=&#39;cursor:pointer;&#39; src=&#39;&quot;</span><span class="o">+</span> <span class="nx">prev_image</span> <span class="o">+</span> <span class="s2">&quot;&#39; width=100  height=66&gt;&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#left_arrow&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#left_border&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#left&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span><span class="mi">1</span> <span class="p">){</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#right&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&lt;img style=&#39;cursor:pointer;&#39;  src=&#39;&quot;</span><span class="o">+</span> <span class="nx">next_image</span> <span class="o">+</span> <span class="s2">&quot;&#39; width=100  height=66&gt;&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#right&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#right_arrow&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#right_border&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.lu-learn-phraseA&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">word1</span> <span class="o">+</span> <span class="nx">entity_phonetics</span><span class="p">);</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.lu-learn-phraseB&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">word2</span><span class="p">);</span>
</span><span class='line'>             <span class="nx">kp_audio_html</span><span class="o">=</span><span class="s1">&#39;&lt;div id=&quot;player2&quot; class=&quot;busuu-player&quot;&gt;&lt;/div&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">$</span><span class="p">(</span><span class="nx">xml</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;keyphrase1&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.table-lu-key-phrases&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">kp_audio</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#kp1&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">phrase1</span> <span class="o">+</span> <span class="nx">kp_phonetics</span><span class="p">);</span>
</span><span class='line'>                  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#kp_divider&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
</span><span class='line'>                  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#kp2&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">phrase2</span><span class="p">);</span>
</span><span class='line'>                  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#kp-audio&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">kp_audio_html</span><span class="p">);</span>
</span><span class='line'>                  <span class="nx">activatePlayer2</span><span class="p">();</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#kp1&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">phrase1</span> <span class="o">+</span> <span class="nx">kp_phonetics</span><span class="p">);</span>
</span><span class='line'>                  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#kp_divider&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
</span><span class='line'>                  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#kp2&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">phrase2</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.table-lu-key-phrases&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#kp_divider&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.table-lu-key-phrases&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.lu-review-ratio&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">((</span><span class="nx">index</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#middle&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">image</span><span class="p">);</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#middle&quot;</span><span class="p">).</span><span class="nx">children</span><span class="p">().</span><span class="nx">fadeIn</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
</span><span class='line'>           <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Разгоняем мозг]]></title>
    <link href="http://greyblake.com/blog/2012/01/30/razgonyaem-mozg/"/>
    <updated>2012-01-30T00:33:36+01:00</updated>
    <id>http://greyblake.com/blog/2012/01/30/razgonyaem-mozg</id>
    <content type="html"><![CDATA[<p>Несколько месяцев назад я был очень сильно озабочен своей продуктивностью. Здесь собраны некоторые рецепты повышения эффективности мозговой деятельности, которые мне удалось отыскать, большинство из них взяты из книги Вина Венгера &#8220;Фактор Эйнштейна&#8221;.</p>

<!--more-->


<ul>
<li><a href="http://www.youtube.com/watch?v=-Q3cW5pBd6Q">Соната Моцарта для 2х фортепиано в Ре мажоре K.448</a>. 10 минут прослушивания поднимают IQ на 8-9 пунктов на 15 минут.</li>
<li>Задержка дыхания. Возможно, даже стоит заняться подводным плаванием. Улучшается кровоснабжение мозга.</li>
<li>Упражнение &#8220;Поток образов&#8221; (читай книгу &#8220;Фактор Эйнштейна&#8221;).</li>
<li>Голод. Стимулирует творческую деятельность.</li>
<li>Воздержание от секса, если верить Фрейду, ибо либидо направляется в нужное русло. Но я ему не верю ;)</li>
<li>Запах лимона <a href="http://persona.rin.ru/news/147136/f/zapah-limona-stimuliruet-rabotu-golovnogo-mozga">улучшает мозговую деятельность</a></li>
<li>Метроном 60 ударов в минуту или музыка эпохи Барокко - вводит человека в лучшее состояние для обучения и запоминание информации.  <a href="http://www.yugzone.ru/psy/iq.htm">http://www.yugzone.ru/psy/iq.htm</a></li>
</ul>


<p>Кроме всего перечисленного выше, не стоит забывать, что восьмичасовой сон никто не отменял ;)</p>
]]></content>
  </entry>
  
</feed>

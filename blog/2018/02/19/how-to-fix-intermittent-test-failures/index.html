
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>How to fix intermittent test failures - Sergey Potapov</title>
  <meta name="author" content="Sergey Potapov">

  
  <meta name="description" content=". You probably happened to face some nasty tests in your continuous integration,
that fails from to time and make your build red.
It slows down the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://greyblake.com/blog/2018/02/19/how-to-fix-intermittent-test-failures/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Sergey Potapov" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-20913158-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Sergey Potapov</a></h1>
  <div id="logo">
  	<div id="logoLeft">[</div>
  	<div id="logoText">greyblake</div>
  	<div id="logoRight">]</div>
  	<div class="clear"></div>
  </div>
  
    <h2>A word from rustacean, rubist and linuxoid.</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:greyblake.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about-me">About me</a></li>
  <li><a href="/projects">Projects</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">How to Fix Intermittent Test Failures</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2018-02-19T20:18:00+01:00" pubdate data-updated="true">Feb 19<span>th</span>, 2018</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><img src="/images/how-to-fix-intermittent-test-failures.jpg" alt="Red build in CI? Works on my machine" />.</p>

<p>You probably happened to face some nasty tests in your continuous integration,
that fails from to time and make your build red.
It slows down the deployment pipeline and could be very annoying.</p>

<p>In my opinion, intermittent tests could be divided into two major groups: order dependent tests and intermittent tests by themselves.
I will cover both in this article.</p>

<ul>
<li><a href="/blog/2018/02/19/how-to-fix-intermittent-test-failures/#order-dependent-tests">Order dependent tests</a>

<ul>
<li><a href="/blog/2018/02/19/how-to-fix-intermittent-test-failures/#how-to-reproduce-order-dependent-tests">How to reproduce order dependent tests?</a></li>
<li><a href="/blog/2018/02/19/how-to-fix-intermittent-test-failures/#how-to-fix-order-dependent-tests">How to fix order dependent tests?</a></li>
</ul>
</li>
<li><a href="/blog/2018/02/19/how-to-fix-intermittent-test-failures/#single-intermittent-tests">Single intermittent tests</a>

<ul>
<li><a href="/blog/2018/02/19/how-to-fix-intermittent-test-failures/#order-related-problems">Order related problems</a>

<ul>
<li><a href="/blog/2018/02/19/how-to-fix-intermittent-test-failures/#database-selection-without-ordering">Database selection without ordering</a></li>
<li><a href="/blog/2018/02/19/how-to-fix-intermittent-test-failures/#unstable-sort">Unstable sort</a></li>
<li><a href="/blog/2018/02/19/how-to-fix-intermittent-test-failures/#iterating-over-hashmap-like-structures">Iterating over HashMap-like structures</a></li>
<li><a href="/blog/2018/02/19/how-to-fix-intermittent-test-failures/#other-order-related-problems">Other order related problems</a></li>
</ul>
</li>
<li><a href="/blog/2018/02/19/how-to-fix-intermittent-test-failures/#time-and-timezone-related-failures">Time and timezone related failures</a></li>
</ul>
</li>
<li><a href="/blog/2018/02/19/how-to-fix-intermittent-test-failures/#confusion">Conclusion</a></li>
<li><a href="/blog/2018/02/19/how-to-fix-intermittent-test-failures/#resources">Resources</a></li>
</ul>


<h2><a name="order-dependent-tests"></a> Order dependent tests</h2>

<p><strong>An order dependent test is a test that always passes in isolation but fails when it runs with other tests in a particular order</strong>.</p>

<p>Example: let&#8217;s say we have tests <code>A</code> and <code>B</code>. Test <code>A</code> passes in isolation and passes
when we run sequence <code>A, B</code>, but permanently fails in sequence <code>B, A</code>.</p>

<p>Usually, it happens when test <code>B</code> does not clean up the environment properly and this in some way affects <code>A</code>.</p>

<h3><a name="how-to-reproduce-order-dependent-tests"></a> How to reproduce order dependent tests?</h3>

<p>Quite often in CI tests run in a random order. For reproduction, it&#8217;s important to know the exact order.</p>

<p>Let&#8217;s say you know from your CI logs that in a test sequence <code>A, B, C, D, E, F</code>  test <code>E</code> fails.
Most likely it fails because one of the preceding tests changes the global environment.</p>

<p>Try to run sequence <code>A, B, C, D, E</code> locally to confirm the hypothesis.
Make sure that tests run exactly in the specified order. If you&#8217;re using RSpec you need to
pass <code>--order defined</code> option.</p>

<pre><code>rspec --order defined ./a_spec.rb ./b_spec.rb ./c_spec.rb ./d_spec.rb ./e_spec.rb
</code></pre>

<p>Now how do you know which of <code>A</code>, <code>B</code>, <code>C</code>, <code>D</code> makes <code>E</code> break? You need to experiment, running different sequences like
<code>A, E</code>, <code>B, E</code>, <code>C, E</code>, <code>D, E</code>. If there are a lot of tests it may take long, so I prefer to use binary search.
Split preceding tests into 2 groups: <code>A, B</code> and <code>C, D</code> and determine which of the following sequences fail:
<code>A, B, E</code> or <code>C, D, E</code>. Then do the same with the failing group until you get a minimal reproducible example. E.g.</p>

<pre><code>rspec --order defined ./b_spec.rb ./e_spec.rb
</code></pre>

<!--more-->


<h3><a name="how-to-fix-order-dependent-tests"></a> How to fix order dependent tests?</h3>

<p>Now you need to inspect test <code>B</code> to see where exactly it doesn&#8217;t clean up the environment.
Quite often it can be one of the following reasons:</p>

<ul>
<li>The test creates new records in the database without deleting them after.</li>
<li>The test stubs some object methods (e.g. <code>Time.now</code>) without reverting the change.</li>
</ul>


<p>It often happens with <code>Timecop</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before</span> <span class="p">{</span> <span class="no">Timecop</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span> <span class="mo">02</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># If this is forgotten, the time will be frozen for all the subsequent tests</span>
</span><span class='line'><span class="n">after</span> <span class="p">{</span> <span class="no">Timecop</span><span class="o">.</span><span class="n">return</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>The test creates files in the file system and does not delete them after.</li>
<li>The test defines some classes that conflict with real classes from the code and it breaks autoloading mechanism in Rails.</li>
</ul>


<p>The latest point may not be easy to understand, so let me illustrate it with an example.
Let&#8217;s say we have <code>DummyModule</code> module that we want to test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">DummyModule</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">dummy</span>
</span><span class='line'>    <span class="s2">&quot;dummy&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The test may look like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">DummyModule</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">DummyService</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">DummyModule</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">subject</span><span class="p">(</span><span class="ss">:service</span><span class="p">)</span> <span class="p">{</span> <span class="no">DummyService</span><span class="o">.</span><span class="n">new</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;includes dummy method&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">dummy</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="s2">&quot;dummy&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So what&#8217;s wrong with it? It creates a new global constant named <code>DummyService</code>.
The constant lives even when the test ends. If you define <code>DummyService</code> in multiple tests they overlap
and may have side effects. Or if you have real <code>DummyService</code> class in you rails app in <code>app/services/dummy_service.rb</code>,
and you run a test sequence, where <code>dummy_service_spec.rb</code> follows <code>dummy_module_spec.rb</code>, you may get an order
dependent test.</p>

<p>Since <code>DummyService</code> is already defined in <code>dummy_module_spec.rb</code> rails autoload will never try to load
<code>app/service/dummy_service.rb</code> file and as result <code>dummy_service_spec.rb</code> will fail, because
it tests a wrong version of <code>DummyService</code> (defined in <code>dummy_module_spec.rb</code>).</p>

<p>To test such modules you should prefer to use anonymous classes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">DummyModule</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">subject</span><span class="p">(</span><span class="ss">:service</span><span class="p">)</span> <span class="p">{</span> <span class="n">dummy_class</span><span class="o">.</span><span class="n">new</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:dummy_class</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">Class</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
</span><span class='line'>      <span class="kp">include</span> <span class="no">DummyModule</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;includes dummy method&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">dummy</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="s2">&quot;dummy&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Such test does not pollute global environment.</p>

<h2><a name="single-intermittent-tests"></a> Single intermittent tests</h2>

<h3><a name="order-related-problems"></a> Order related problems</h3>

<p>Sometimes programming languages and databases have undefined behavior regarding
order related operations. We, developers, may make wrong assumptions about it
and introduce a bug or an intermittent test.
Fortunately, those issues are often easy to spot and fix.</p>

<h4><a name="database-selection-without-ordering"></a> Database selection without ordering</h4>

<p>Most of the databases do not guarantee an order of returned items unless it&#8217;s explicitly specified in the request.
You should always keep this in mind if your test relies on a specific order.</p>

<p>Assume we have an ActiveRecord model <code>User</code> and we want to write a test for
<code>fetch_all_users</code> function, which returns all existing records from the database.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">fetch_all_users</span>
</span><span class='line'>  <span class="no">User</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">it</span> <span class="s2">&quot;fethes all existing records&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Anthony&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Ahmed&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Paulo&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Max&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Ricardo&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">names</span> <span class="o">=</span> <span class="n">fetch_all_users</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;Anthony&quot;</span><span class="p">,</span> <span class="s2">&quot;Ahmed&quot;</span><span class="p">,</span> <span class="s2">&quot;Paulo&quot;</span><span class="p">,</span> <span class="s2">&quot;Max&quot;</span><span class="p">,</span> <span class="s2">&quot;Ricardo&quot;</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>At first glance, this test may look innocent. And it will probably pass if you try to run it.
I had to loop the test and run it about 5000 times to reproduce one single failure
(with PostgreSQL 9.5, and RSpec option <code>use_transactional_fixtures</code> set to <code>false</code>):</p>

<pre><code>1) fethes all existing records
   Failure/Error: expect(names).to eq ["Anthony", "Ahmed", "Paulo", "Max", "Ricardo"]

     expected: ["Anthony", "Ahmed", "Paulo", "Max", "Ricardo"]
          got: ["Max", "Ricardo", "Anthony", "Ahmed", "Paulo"]
</code></pre>

<p>There are two possible solutions to make the test stable.</p>

<p>First one is to modify <code>fetch_all_users</code> to enforce the order of returned items:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">fetch_all_users</span>
</span><span class='line'>  <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The second one, if you really don&#8217;t care about the order,
is to update the test to be order-agnostic.
With RSpec you can use <a href="http://www.rubydoc.info/gems/rspec-expectations/RSpec/Matchers#contain_exactly-instance_method">contain_exactly</a>
matcher for that. As the documentation says:</p>

<blockquote><p>Passes if actual contains all of the expected regardless of order.</p></blockquote>


<p>So the expectation statement becomes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">contain_exactly</span><span class="p">(</span><span class="s2">&quot;Anthony&quot;</span><span class="p">,</span> <span class="s2">&quot;Ahmed&quot;</span><span class="p">,</span> <span class="s2">&quot;Paulo&quot;</span><span class="p">,</span> <span class="s2">&quot;Max&quot;</span><span class="p">,</span> <span class="s2">&quot;Ricardo&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4><a name="unstable-sort"></a> Unstable sort</h4>

<p>You should learn the difference between stable and unstable sorting algorithms and know which one
is used by default in your programming language and your database.</p>

<p>Let&#8217;s take a look at an example with a stable sorting algorithm.
Here we have 3 people, 2 of them have the same age. We&#8217;re gonna sort people by age.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Reproduced on MRI 2.4.2 which has a stable sorting algorithm.</span>
</span><span class='line'><span class="c1"># NOTE: different ruby implementation and versions use different sort algorithms be default.</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:age</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">age</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
</span><span class='line'>    <span class="vi">@age</span> <span class="o">=</span> <span class="n">age</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">&lt;=&gt;</span> <span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;=&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">age</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">people_set1</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>  <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Bernard&quot;</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span>
</span><span class='line'>  <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Johannes&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
</span><span class='line'>  <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Steffen&quot;</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
</span><span class='line'><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Bernard precedes Steffen (as in the input data set)</span>
</span><span class='line'><span class="nb">p</span> <span class="n">people_set1</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span> <span class="c1"># =&gt; [&quot;Johannes&quot;, &quot;Bernard&quot;, &quot;Steffen&quot;]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Now let&#39;s swap Bernard and Steffen</span>
</span><span class='line'><span class="n">people_set2</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>  <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Steffen&quot;</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span>
</span><span class='line'>  <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Johannes&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
</span><span class='line'>  <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Bernard&quot;</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
</span><span class='line'><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Now Steffen precedes Bernard</span>
</span><span class='line'><span class="nb">p</span> <span class="n">people_set2</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span> <span class="c1"># =&gt; [&quot;Johannes&quot;, &quot;Steffen&quot;, &quot;Bernard&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Stable sorting algorithms retain the relative order of items with equal keys</strong>.</p>

<p>As you may conclude, unstable sorting algorithms are those, that do not match the
definition of &#8220;stable sorting algorithm&#8221;.</p>

<p>However, there are 2 possible types of unstable sorting algorithms:</p>

<ul>
<li>Those that persist the same output for the same given input</li>
<li>Those that may return different output when the same input is given</li>
</ul>


<p>The second is not desired and must be avoided since it introduces
a real randomness. An example could be a <a href="https://en.wikipedia.org/wiki/Quicksort">quicksort</a>
implementation with literally randomly chosen pivot.</p>

<p>Most of the languages have the first type of unstable sort. But it&#8217;s good to be on the alert.</p>

<p>By the way, if you wonder what kind of sorting algorithm has your Ruby version,
I recommend you to take a look at this <a href="https://stackoverflow.com/a/44486562/1013173">stackoverflow answer</a>.</p>

<h4><a name="iterating-over-hashmap-like-structures"></a> Iterating over HashMap-like structures</h4>

<p>HashMap-like structures are widely used in many scripting languages: in Ruby it&#8217;s called &#8220;hash&#8221;, in JavaScript - &#8220;object&#8221;,
in Python - &#8220;dictionary&#8221;, in PHP - &#8220;associated array&#8221;, etc.</p>

<p>The problem is, some implementations do not guarantee order persistence on iteration over HashMap keys.
For example it was the case for Ruby before version 1.9, that&#8217;s why ActiveSupport used to have
<a href="http://api.rubyonrails.org/v3.2/classes/ActiveSupport/OrderedHash.html">OrderedHash</a>.</p>

<p>In case of JavaScript <a href="http://2ality.com/2015/10/property-traversal-order-es6.html">the traversion order was only defined in ES6</a>.</p>

<p>Here is a little Rust program, that illustrates the issue with an equivalent Ruby code in
the comments.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="c1">// Reproduced with rust version 1.22.1</span>
</span><span class='line'><span class="k">use</span> <span class="n">std</span><span class="o">::</span><span class="n">collections</span><span class="o">::</span><span class="n">HashMap</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// hash = { 1 =&gt; 1, 2 =&gt; 4 }</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">mut</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">HashMap</span><span class="o">::</span><span class="n">new</span><span class="p">();</span>
</span><span class='line'>    <span class="n">hash</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span><span class='line'>    <span class="n">hash</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">4</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// keys = hash.keys</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">keys</span><span class="o">:</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="k">i32</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">hash</span><span class="p">.</span><span class="n">keys</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="o">*</span><span class="n">x</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// expect(keys).to eq [1, 2]</span>
</span><span class='line'>    <span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">])</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you run this program multiple times, sometimes it may succeed, sometimes it fails:</p>

<pre><code>thread 'main' panicked at 'assertion failed: `(left == right)`
  left: `[2, 1]`,
 right: `[1, 2]`', src/main.rs:16:4
</code></pre>

<p>The solution is the same as for the previous order related problems.
Either to update the code to sort keys explicitly or to make the test be order agnostic:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="c1">// keys = hash.keys</span>
</span><span class='line'><span class="k">let</span> <span class="k">mut</span> <span class="n">keys</span><span class="o">:</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="k">i32</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">hash</span><span class="p">.</span><span class="n">keys</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="o">*</span><span class="n">x</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// keys.sort!</span>
</span><span class='line'><span class="n">keys</span><span class="p">.</span><span class="n">sort</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// expect(keys).to eq [1, 2]</span>
</span><span class='line'><span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<h4><a name="other-order-related-problems"></a> Other order related problems</h4>

<p>Everything that has not 100% defined behavior may lead to the similar issues.
There are few other examples:</p>

<ul>
<li>Iterating over entries in the file system may vary depending on a file system, operating system, file system drivers, etc.</li>
<li>If you run concurrent operations they are not guaranteed to finish in the order they start. So you may want to do some kind of sorting to aggregate the final result.</li>
</ul>


<h3><a name="time-and-timezone-related-failures"></a> Time and timezone related failures</h3>

<p>Tests should not depend on current time and date.</p>

<p>It&#8217;s not obvious, but sometime a test may fail on CI just because it runs in a specific time in a
specific (different from your local) timezone. E.g. it may fail in time frame from 20:00 to 00:00
in CI server that runs in Pacific Time Zone, but the failure may not be reproducible in Europe.</p>

<p>If you suspect this, the first step would be to change your local time settings in order to
reproduce the same time conditions as on the CI server, when the test failed.</p>

<p>After you&#8217;re able to reproduce the failure locally it must be relatively easy to debug.</p>

<p>Another example of a test that depends on the current time:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">current_year</span>
</span><span class='line'>  <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">year</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">it</span> <span class="s2">&quot;returns current year&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">current_year</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="mi">2018</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Obviously, on the 1st of January 2019 it will start failing.
For this test you&#8217;d need to stub the current time with <a href="https://github.com/travisjeffery/timecop">Timecop</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s2">&quot;returns current year&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">Timecop</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">19</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">current_year</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="mi">2018</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a name="confusion"></a> Conclusion</h2>

<p>We have covered the most common cases where an intermittent test can be
introduced to a smooth CI process. However, some situations may be tricker and tests may fail
only when multiple of the covered factors combined together.</p>

<p>Usually, it is better to spot problems on the code review stage,
at least by now you should know what you should pay attention to.</p>

<p>Also it worth saying, that the article does not cover problems related to concurrency and asynchronous
communication which are very big topics by themselves.</p>

<p>Thanks for reading please give me feedback.
What was the toughest intermittent you had to debug? =)</p>

<h2><a name="resources"></a> Resources</h2>

<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Mozilla/QA/Avoiding_intermittent_oranges">Avoiding intermittent test failures</a></li>
<li><a href="https://8thlight.com/blog/will-warner/2013/03/26/stable-sorting-in-ruby.html">Stable Sorting in Ruby</a></li>
<li><a href="https://stackoverflow.com/a/44486562/1013173">Comparison of different ruby implementations for sorting stability</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Sergey Potapov</span></span>

      








  


<time datetime="2018-02-19T20:18:00+01:00" pubdate data-updated="true">Feb 19<span>th</span>, 2018</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ci-/'>ci,</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/rspec-/'>rspec,</a>, <a class='category' href='/blog/categories/ruby-/'>ruby,</a>, <a class='category' href='/blog/categories/rust-/'>rust,</a>, <a class='category' href='/blog/categories/tests-/'>tests,</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://greyblake.com/blog/2018/02/19/how-to-fix-intermittent-test-failures/" data-via="greyblake" data-counturl="http://greyblake.com/blog/2018/02/19/how-to-fix-intermittent-test-failures/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/blog/2018/01/16/rust-2018/" title="Previous Post: Rust 2018">&laquo; Rust 2018</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/02/19/how-to-fix-intermittent-test-failures/">How to fix intermittent test failures</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/01/16/rust-2018/">Rust 2018</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/09/02/how-to-run-rust-tests-automatically/">How to run Rust tests automatically</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/08/20/announcing-crystalium-organization/">Announcing Crystalium organization</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/08/10/exposing-rust-library-to-c/">Exposing a Rust library to C</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/greyblake">@greyblake</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'greyblake',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Sergey Potapov -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'greyblake';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://greyblake.com/blog/2018/02/19/how-to-fix-intermittent-test-failures/';
        var disqus_url = 'http://greyblake.com/blog/2018/02/19/how-to-fix-intermittent-test-failures/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
